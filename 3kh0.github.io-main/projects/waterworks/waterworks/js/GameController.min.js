class GameController{constructor(p){_defineProperty(this,"syncMedals",()=>{if(null!=ngio&&ngio.user){for(var i=0;i<medals.length;i++){var medal=medals[i];medal.unlocked&&("Herman's Ditch"==medal.name&&(this.ach_hermans=!0),"Trynka Canal"==medal.name&&(this.ach_trynka=!0),"A Wheel Of Fortune"==medal.name&&(this.ach_fortune=!0),"A Winner Is You"==medal.name&&(this.ach_s1=!0),"Glitter And Gold"==medal.name&&(this.ach_coins=!0),"I Request An Achievement"==medal.name&&(this.ach_requests=!0),"I Don't Feel So Well"==medal.name&&(this.ach_well=!0),"Never A Dull Moment"==medal.name&&(this.ach_time=!0),"Waterbender"==medal.name&&(this.ach_s2=!0),"Nothing Is Impossible"==medal.name&&(this.ach_s3=!0))}1==this.ach_hermans&&this.unlockMedal("hermans"),1==this.ach_trynka&&this.unlockMedal("trynka"),1==this.ach_fortune&&this.unlockMedal("fortune"),1==this.ach_s1&&this.unlockMedal("s1"),1==this.ach_coins&&this.unlockMedal("coins"),1==this.ach_requests&&this.unlockMedal("requests"),1==this.ach_well&&this.unlockMedal("well"),1==this.ach_time&&this.unlockMedal("time"),1==this.ach_s2&&this.unlockMedal("s2"),1==this.ach_s3&&this.unlockMedal("s3"),this.menu&&this.menu.saveState()}}),_defineProperty(this,"unlockMedal",medal_name=>{if(null!=ngio&&ngio.user)for(var medal=null,i=0;i<medals.length;i++)if("Herman's Ditch"==(medal=medals[i]).name&&"hermans"==medal_name||"Trynka Canal"==medal.name&&"trynka"==medal_name||"A Wheel Of Fortune"==medal.name&&"fortune"==medal_name||"A Winner Is You"==medal.name&&"s1"==medal_name||"Glitter And Gold"==medal.name&&"coins"==medal_name||"I Request An Achievement"==medal.name&&"requests"==medal_name||"I Don't Feel So Well"==medal.name&&"well"==medal_name||"Never A Dull Moment"==medal.name&&"time"==medal_name||"Waterbender"==medal.name&&"s2"==medal_name||"Nothing Is Impossible"==medal.name&&"s3"==medal_name)return void(medal.unlocked||ngio&&ngio.callComponent("Medal.unlock",{id:medal.id},(function(result){ngio.queueComponent("Medal.getList",{},onMedalsLoaded),ngio.executeQueue()})))}),_defineProperty(this,"unlockAchievement",achievname=>{0==this["ach_"+achievname]&&1!=this.difficulty&&(1==ng&&this.unlockMedal(achievname),gameanalytics.GameAnalytics.addDesignEvent("achievement:"+achievname),this["ach_"+achievname]=!0,this.notification.show(achievname),this.menu.saveState())}),_defineProperty(this,"startGame",()=>{this.ambience1.play({mute:!1,volume:2,seek:0,loop:!0,delay:0}),200==this.tutorial||-2==this.tutorial?(this.tutorial=-1,this.endTurnButton.setVisible(!1),this.sellButton.setVisible(!1),this.showSupplyButton.setVisible(!1),this.showPipesButton.setVisible(!1),this.popup.show(getString(this.language,"popup","tutorial_hello","header"),getString(this.language,"popup","tutorial_hello","string"),this.deck.drawCards,null)):(this.endTurnButton.setVisible(!0),this.sellButton.setVisible(!0),this.showSupplyButton.setVisible(!0),this.showPipesButton.setVisible(!0),this.deck.drawCards())}),_defineProperty(this,"pointerDownForDrawers",(pointer,right)=>{this.drawer1&&this.drawer1.pointerDown(pointer,right),this.drawer2&&this.drawer2.pointerDown(pointer,right),this.drawer3&&this.drawer3.pointerDown(pointer,right)}),_defineProperty(this,"lockDrawers",except=>{except!=CARD_TYPE_DOCUMENT&&this.drawer1.container.each(disableChildren),except!=CARD_TYPE_COMPONENT&&this.drawer2.container.each(disableChildren),except!=CARD_TYPE_WORKER&&this.drawer3.container.each(disableChildren)}),_defineProperty(this,"unlockDrawers",()=>{this.drawer1.container.each(enableChildren),this.drawer2.container.each(enableChildren),this.drawer3.container.each(enableChildren)}),_defineProperty(this,"updateDrawerCards",()=>{this.drawer1&&this.drawer1.updateCards(),this.drawer2&&this.drawer2.updateCards(),this.drawer3&&this.drawer3.updateCards()}),_defineProperty(this,"optionsButtonClick",pointer=>{this.options.show()}),_defineProperty(this,"sellButtonClick",pointer=>{this.switchSellMode(!this.isBulldozer,pointer)}),_defineProperty(this,"pipeButtonClick",()=>{var target=0;target=this.showPipes>=.5?0:1,this.phaser.tweens.add({targets:this,showPipes:target,ease:"Cubic.InOut",duration:250,onUpdate:this.town.refreshPipesView,onUpdateScope:this}),18==this.tutorial?this.tutorial=19:19==this.tutorial&&(this.tutorial=100,this.endTurnButton.setVisible(!0)),1==target?(this.town.showWellPower(),this.showPipesButton.button.setTexture("gui","pipe_active"),this.showPipesButton.hover.setTexture("gui","pipe_over_active")):(this.town.hideWellPower(!0),this.showPipesButton.button.setTexture("gui","pipe"),this.showPipesButton.hover.setTexture("gui","pipe_over"))}),_defineProperty(this,"supplyButtonClick",()=>{4==this.tutorial?(this.tutorial=5,this.phaser.input.enabled=!1,setTimeout((function(t){t.phaser.input.enabled=!0,t.tutorial=6}),3e3,this)):6==this.tutorial&&(this.rays1.visible=!0,this.rays2.visible=!0,this.tutorial=7),this.alwaysShowSupplyDemand=!this.alwaysShowSupplyDemand,this.alwaysShowSupplyDemand?(this.town.showSupplyDemand(),this.showSupplyButton.button.setTexture("gui","supply_active"),this.showSupplyButton.hover.setTexture("gui","supply_over_active")):(this.town.hideSupplyDemand(),this.showSupplyButton.button.setTexture("gui","supply"),this.showSupplyButton.hover.setTexture("gui","supply_over"))}),_defineProperty(this,"switchSellMode",(state,pointer)=>{null!=state&&(this.isBulldozer=state,this.isTargetingStreets=state,this.isTargetingNodes=state,pointer&&0==pointer.id?this.moneybag.visible=state:this.moneybag.visible=!1,1==state?this.sellButton.button.setTexture("gui","moneybag2_active"):this.sellButton.button.setTexture("gui","moneybag2"),1==state?this.sellButton.hover.setTexture("gui","moneybag2_active_down"):this.sellButton.hover.setTexture("gui","moneybag2_down")),this.updateLocks()}),_defineProperty(this,"pay",(costMoney,costInfluence,pointer,forReal,allowNegative)=>{this.cost_sound1=null,this.cost_sound2=null,this.cost_bmp=this.phaser.add.bitmapText(1,25,"text_white",""),this.cost_bmp.setDepth(2e3),this.cost_bmp.text="";var success=!0;if(0==allowNegative&&(this.money<costMoney&&costMoney>0||0!=costInfluence&&this.infl<costInfluence)&&(success=!1,this.deny.play(),this.money<costMoney&&costMoney>0&&(this.cost_bmp.text+=getString(this.language,"gui","not_enough_money","string")+"\n\n"),this.infl<costInfluence&&costInfluence>0&&(this.cost_bmp.text+=getString(this.language,"gui","not_enough_infl","string"))),success&&forReal){var time,time;if(0!=costMoney)this.money-=costMoney,costMoney<0&&1!=this.difficulty&&(this.ach_coins_count-=costMoney,this.ach_coins_count>=ACH_COINS_TO_COLLECT&&this.unlockAchievement("coins")),this.cost_bmp.text+="@ ",costMoney<0&&(this.cost_bmp.text+="+"),this.cost_bmp.text+=-costMoney+"\n\n",costMoney>0?this.cost_sound1=this.phaser.sound.add("buy"):costMoney<0&&(this.cost_sound1=this.phaser.sound.add("coin")),null!=this.moneyCounter&&this.moneyCounter.stop(),(time=100*Math.abs(this.displayedMoney-this.money))>1e3&&(time=1e3),this.moneyCounter=this.phaser.tweens.addCounter({from:this.displayedMoney,to:this.money,duration:time,delay:0,onUpdate:function(tween){var value=Math.floor(tween.getValue());this.updateMoneyInfl(value,null),this.displayedMoney=value},onUpdateScope:this,onComplete:function(){this.displayedMoney=this.money},onCompleteScope:this});if(0!=costInfluence||1==allowNegative)if(this.cost_sound2=costInfluence>0?this.phaser.sound.add("infl_neutral"):costInfluence<0?this.phaser.sound.add("infl"):this.phaser.sound.add("infl_lose"),costInfluence<0&&this.infl+-costInfluence>100)this.inflHit100=!0,costInfluence+=100-this.infl,this.infl=100,this.money-=Math.floor(costInfluence/2),this.cost_bmp.text+="@ ",this.cost_bmp.text+="+",this.cost_bmp.text+=-Math.floor(costInfluence/2)+"\n\n",costInfluence/2!=Math.floor(costInfluence/2)&&(this.infl-=1,this.cost_bmp.text+="# -1\n\n"),null!=this.moneyCounter&&this.moneyCounter.stop(),(time=100*Math.abs(this.displayedMoney-this.money))>1e3&&(time=1e3),this.moneyCounter=this.phaser.tweens.addCounter({from:this.displayedMoney,to:this.money,duration:time,delay:0,onUpdate:function(tween){var value=Math.floor(tween.getValue());this.updateMoneyInfl(value,null),this.displayedMoney=value},onUpdateScope:this,onComplete:function(){this.displayedMoney=this.money},onCompleteScope:this});else(0!=costInfluence||this.endingTurn)&&(this.cost_bmp.text+="# ",costInfluence<=0&&(this.cost_bmp.text+="+"),this.cost_bmp.text+=-costInfluence,this.infl-=costInfluence,costInfluence<=5?this.inflCounter.push(this.phaser.tweens.addCounter({from:this.displayedInfl,to:this.infl,duration:50,delay:50*this.inflCounter.length,onUpdate:function(tween){var value=Math.floor(tween.getValue());this.updateMoneyInfl(null,value),this.displayedInfl=value},onUpdateScope:this,onComplete:function(){this.inflCounter.shift()},onCompleteScope:this})):this.phaser.tweens.addCounter({from:this.displayedInfl,to:this.infl,duration:500,delay:0,onUpdate:function(tween){var value=Math.floor(tween.getValue());this.updateMoneyInfl(null,value),this.displayedInfl=value},onUpdateScope:this}))}if(forReal||!success&&!forReal){this.cost_bmp.alpha=1,this.cost_bmp.setCenterAlign(),this.cost_bmp.x=pointer.x+10*Math.random()-5,this.cost_bmp.y=pointer.y-20;var szer=this.cost_bmp.width/2;if(this.cost_bmp.y<25&&(this.cost_bmp.y=25),this.cost_bmp.scale=0,this.cost_sound1&&(this.cost_sound1.play({volume:1.5,detune:this.buyDetune}),this.buyDetune+=30+10*Math.random(),this.buyDetune>300&&(this.buyDetune=300)),this.cost_sound2){var range1=0,range2=0,vol=.5;0==costInfluence&&(range1=this.infDetune2,this.infDetune2+=20+5*Math.random()),costInfluence>0&&(range1=-this.infDetune,this.infDetune+=30+5*Math.random()),costInfluence<0&&(range1=this.infDetune2,this.infDetune2+=20+5*Math.random()),this.infDetune2>300&&(this.infDetune2=300),this.cost_sound2.play({volume:.5,detune:range1+0*Math.random()})}this.phaser.tweens.add({targets:this.cost_bmp,scale:1,x:this.cost_bmp.x-szer,ease:"Quad.Out",duration:200}),this.phaser.tweens.add({targets:this.cost_bmp,y:this.cost_bmp.y-50,ease:"Quad.Out",duration:4e3}),this.phaser.tweens.add({targets:[this.cost_bmp,this.cost_sound1],alpha:0,ease:"Quad.Out",duration:2e3,delay:2e3,onComplete:function(){this.targets[0].destroy(),this.targets[1]&&this.targets[1].destroy()}})}return this.updatePriceAvailability(),this.updateDrawerCards(),success}),_defineProperty(this,"updateInflGain",()=>{var plusminus="+",inflp=this.town.calculateInflGain();inflp<0&&(plusminus="");var plusminusS="+",inflpS=this.town.calculateInflGainSimulated();inflpS<0&&(plusminusS=""),this.infl2_bmp&&(inflp<-10?this.infl2_bmp.setTint(16711680):inflp<=0?this.infl2_bmp.setTint(16766976):this.infl2_bmp.clearTint(),this.infl2_bmp.setText(" ["+plusminus+inflp+"]"),null!=this.selectedItem&&null!=this.selectedItem.gainWater1&&0!=this.selectedItem.gainWater1&&(inflpS<inflp?this.infl2_bmp.setTint(16711680):inflpS>inflp?this.infl2_bmp.setTint(55296):this.infl2_bmp.clearTint(),this.infl2_bmp.setText(" ["+plusminus+inflp+"}>}"+plusminusS+inflpS+"]")),this.infl2_bmp.x=this.infl_bmp.x+this.infl_bmp.width,this.infl_bmp.input.hitArea.setSize(this.infl_bmp.width,this.infl_bmp.height),this.infl2_bmp.input.hitArea.setSize(this.infl2_bmp.width,this.infl2_bmp.height))}),_defineProperty(this,"updateMoneyInfl",(money,infl)=>{if(null!=money){var plusminus="+";this.moneyGain<0&&(plusminus=""),this.money_bmp&&this.money_bmp.setText("@"+money),this.money2_bmp&&(this.money2_bmp.setText(" ["+plusminus+this.moneyGain+"]"),this.money2_bmp.x=this.money_bmp.x+this.money_bmp.width,this.money_bmp.input.hitArea.setSize(this.money_bmp.width,this.money_bmp.height),this.money2_bmp.input.hitArea.setSize(this.money2_bmp.width,this.money2_bmp.height))}null!=infl&&(this.infl_bmp&&this.infl_bmp.setText("#"+infl),this.updateInflGain(),infl<-50?this.infl_bmp.setTint(16711680):infl<0?this.infl_bmp.setTint(16766976):this.infl_bmp.clearTint())}),_defineProperty(this,"updatePriceAvailability",()=>{this.hand.updatePriceAvailability(),this.construction.update(),this.request.update()}),_defineProperty(this,"hideCurtainSlow",()=>{this.phaser.tweens.add({targets:this.curtain,alpha:0,ease:"Cubic.Out",duration:1e3,onComplete:function(){this.phaser.input.enabled=!0},onCompleteScope:this})}),_defineProperty(this,"hideCurtain",()=>{this.phaser.tweens.add({targets:this.curtain,alpha:0,ease:"Cubic.Out",duration:200})}),_defineProperty(this,"showCurtain",(alpha,layer)=>{this.curtain.setDepth(layer),this.phaser.tweens.add({targets:this.curtain,alpha:alpha,ease:"Cubic.Out",duration:200})}),_defineProperty(this,"setEverythingEnabled",value=>{this.town.refreshPipes(),this.town.setGlobalEnabled(value),this.town.setBlocksEnabled(value),this.town.setWalkersEnabled(value),this.town.setNodesEnabled(value,!1,!1),this.town.setStreetsEnabled(value,!1),this.hand.setCardsEnabled(value)}),_defineProperty(this,"setDefaultEnabled",()=>{this.town.refreshPipes(),this.town.setGlobalEnabled(!1),this.town.setNodesEnabled(!0,!1,!0),this.town.setStreetsEnabled(!1,!1),this.town.setBlocksEnabled(!1),this.town.setWalkersEnabled(!0),this.hand.setCardsEnabled(!0)}),_defineProperty(this,"updateLocks",()=>{var ok=!0;if(this.updateMoneyInfl(this.money,this.infl),this.setDefaultEnabled(),(this.isDraggingCard||this.isInOptions)&&(ok=!1,this.setEverythingEnabled(!1)),this.isDraggingWalker&&(ok=!1,this.setEverythingEnabled(!1)),this.isTargetingGlobal&&0==this.construction.open&&0==this.request.open&&(ok=!1,this.town.setGlobalEnabled(!0)),this.isTargetingBlocks&&0==this.construction.open&&0==this.request.open&&(ok=!1,this.town.setBlocksEnabled(!0)),this.isTargetingStreets&&0==this.construction.open&&0==this.request.open&&(ok=!1,this.town.checkWaterPath(),this.town.setStreetsEnabled(!0,this.isBulldozer)),this.isTargetingNodes&&0==this.construction.open&&0==this.request.open&&(ok=!1,this.town.checkWaterPath(),this.town.setNodesEnabled(!0,this.isBulldozer,!1)),this.isBulldozer&&(ok=!1,this.hand.setCardsEnabled(!1)),(this.isDroppingCard||this.isUpdatingHand)&&(ok=!1,this.setEverythingEnabled(!1)),this.isDroppingWalker&&(ok=!1,this.setEverythingEnabled(!1),this.hand.setCardsEnabled(!0)),this.rays1&&1==ok&&0==this.endingTurn){this.nothingToDo=!0;for(var i=0;i<this.hand.cards.length;i++)1==this.hand.cards[i].updatePriceAvailability()&&(this.nothingToDo=!1);""!=this.construction.constructionId&&1==this.construction.readyToBuild&&(this.nothingToDo=!1),this.nothingToDo&&this.tutorial>=6&&this.tutorial<200&&12!=this.tutorial&&13!=this.tutorial&&14!=this.tutorial?(this.rays1.visible=!0,this.rays2.visible=!0):(this.rays1.visible=!1,this.rays2.visible=!1)}}),_defineProperty(this,"updateDrawersCounters",()=>{this.drawer1.updateCounter(),this.drawer2.updateCounter(),this.drawer3.updateCounter()}),_defineProperty(this,"endTurnClick",()=>{if(!(null!=this.selectedItem||null!=this.selectedItem||this.isInOptions||this.isUpdatingHand||this.isDrawingCards||this.isDraggingCard||this.isDroppingCard||this.isDraggingWalker||this.isDroppingWalker||this.isTargetingBlocks||this.isTargetingStreets||this.isTargetingNodes||this.isTargetingGlobal)){if(this.clockSound.play(),this.rays1.visible=!1,this.rays2.visible=!1,1==this.construction.open&&this.construction.openCloseConstruction(),1==this.request.open&&this.request.openCloseConstruction(),1==this.drawer1.open&&this.drawer1.openClose(),1==this.drawer2.open&&this.drawer2.openClose(),1==this.drawer3.open&&this.drawer3.openClose(),this.turn++,this.calculatePerTurn(),0==this.tutorialMoveToShelf&&this.options.tutorials){for(var free=!1,i=0;i<this.hand.cards.length;i++){var type=this.hand.cards[i].playType,drawer;type==CARD_TYPE_DOCUMENT&&(drawer=this.drawer1),type==CARD_TYPE_COMPONENT&&(drawer=this.drawer2),type==CARD_TYPE_WORKER&&(drawer=this.drawer3);for(var j=0;j<drawer.level*DRAWER_CARDS_PER_LEVEL;j++)if(null==drawer.slots[j].card){free=!0;break}if(1==free)break}if(1==free)return this.tutorialMoveToShelf=!0,void this.popup.show(getString(this.language,"popup","tutorial_drawer","header"),getString(this.language,"popup","tutorial_drawer","string"),null,null)}if(this.options.tutorials&&0==this.tutorialConstructionInArchive&&""==this.construction.constructionId)for(var i=0;i<this.drawer1.level*DRAWER_CARDS_PER_LEVEL;i++)if(null!=this.drawer1.slots[i].card&&null!=this.drawer1.slots[i].card.constructionStarter){var card=this.drawer1.slots[i].card;if(this.money>=card.costMoney&&this.infl>=card.costInfluence&&(card.updateLanguage(),-1==card.desc2_bmp.text.indexOf("{")))return this.popup.show(getString(this.language,"popup","tutorial_drawer_construction","header"),getString(this.language,"popup","tutorial_drawer_construction","string"),null,null),void(this.tutorialConstructionInArchive=!0)}this.endedTurn=1,this.endTurnButton.button.play("hourglass_anim"),this.phaser.input.enabled=!1,this.endTurnButton.hover.visible=!1,this.endingTurn=!0,this.isDrawingCards=!0,this.isUpdatingHand=!0,this.updateLocks(),this.hand.discardHand(!0),7==this.tutorial?(this.tutorial=8,this.popup.show(getString(this.language,"popup","tutorial_7","header"),getString(this.language,"popup","tutorial_7","string"),this.endTurn1,null)):this.endTurn1()}}),_defineProperty(this,"calculatePerTurn",()=>{var xmlData=this.phaser.cache.xml.get("constructions").getElementsByTagName("construction");this.populationIncreaseConstructions=[];for(var i=0;i<xmlData.length;i++){var cpop=xmlData[i].getAttribute("population");null!=cpop&&parseInt(cpop)<=this.difficultyPopulationMod&&this.populationIncreaseConstructions.push(xmlData[i].getAttribute("id"))}this.perTurn=1;for(var i=0;i<this.town.constructions.length;i++)for(var j=0;j<this.populationIncreaseConstructions.length;j++)this.town.constructions[i]==this.populationIncreaseConstructions[j]&&(this.perTurn+=1);this.popul_bmp.text="` +"+this.perTurn}),_defineProperty(this,"endTurn1",()=>{var delay=150-3*this.moneyGain;delay<5&&(delay=5);var startPoint=new Phaser.Math.Vector2(20,256);startPoint.x+=10+20*Math.random(),startPoint.y+=10+20*Math.random(),this.town.updateSupply(),this.town.showSupplyDemand(),this.town.hideSupplyDemand();for(var i=0;i<this.moneyGain;i++)setTimeout(this.flyMoney,0+delay*i,"@",1,20);setTimeout(this.pay,1e3,-this.moneyGain,0,startPoint,!0,!1),8==this.tutorial?setTimeout((function(t){t.tutorial=9,t.popup.show(getString(t.language,"popup","tutorial_influence","header"),getString(t.language,"popup","tutorial_influence","string"),t.town.earnInfl,null)}),0+delay*this.moneyGain+500,this):setTimeout(this.town.earnInfl,0+delay*this.moneyGain+500)}),_defineProperty(this,"endTurn2",()=>{this.isShowingGains=!1,this.town.hideSupplyDemand(),9==this.tutorial?this.popup.show(getString(this.language,"popup","population_increase","header"),getString(this.language,"popup","population_increase","string"),this.advanceTutorial,null):this.town.increasePopulation(this.perTurn,!0,-1)}),_defineProperty(this,"endTurn3",()=>{if(0==this.town.spreadFire()){for(var i=0;i<this.town.constructions.length;i++)"water_source"==this.town.constructions[i]&&(-999==this.fireChance?this.fireChance=-555:-555==this.fireChance?this.fireChance=100:this.fireChance+=3);if(100*Math.random()<this.fireChance){var rand=Math.floor(20*Math.random());this.town.blocks[rand].startFire(1),this.firealarmsound.play({volume:.25}),this.fireloopsound.play({loop:!0}),this.popup.show(getString(this.language,"popup","fire_started","header"),getString(this.language,"popup","fire_started","string"),this.endTurn4,null),this.fireChance=-7}else this.fireloopsound.stop(),this.endTurn4()}else this.fireloopsound.play({loop:!0}),this.popup.show(getString(this.language,"popup","fire_spreads","header"),getString(this.language,"popup","fire_spreads","string"),this.endTurn4,null),this.firealarmsound.play({volume:.25})}),_defineProperty(this,"endTurn4",()=>{10==this.tutorial&&(this.tutorial=11);for(var maxLevel=0,ok=!1,i=0;i<this.town.constructions.length;i++)"upgraded_water_source"==this.town.constructions[i]&&(ok=!0,maxLevel<1&&(maxLevel=1)),"waterworks2"==this.town.constructions[i]&&maxLevel<2&&(maxLevel=2);if(0!=ok)if(""==this.request.constructionId){if(100*Math.random()<this.requestChance){do{var rand=Math.random();rand=Math.floor(rand*this.requests.length)}while(Number(this.requests[rand].getAttribute("level"))>maxLevel||rand==this.previousRequest);this.notifysound.play(),this.request.startConstruction(this.requests[rand].getAttribute("id")),this.previousRequest=rand,this.requestChance=-10}this.requestChance+=4,this.endTurn5()}else if(this.request.timer--,this.request.update(),this.request.timer<0){this.failsound.play();var str=getString(this.language,"popup","request_failed","string");0!=this.request.loseMoney&&(str+="\n @ "+this.request.loseMoney),0!=this.request.loseInfl&&(str+="\n # "+this.request.loseInfl),this.popup.show(getString(this.language,"popup","request_failed","header"),str,this.requestPenalty,null)}else this.endTurn5();else this.endTurn5()}),_defineProperty(this,"endTurn5",()=>{if(this.buyDetune=-20,this.infDetune=-50,this.infDetune2=-50,this.round_bmp.text=getString(this.language,"gui","turn","string")+" "+this.turn,this.popul_bmp.text="` +"+this.perTurn,this.round_bmp.input.hitArea.setSize(this.round_bmp.width,this.round_bmp.height),this.popul_bmp.input.hitArea.setSize(this.popul_bmp.width,this.popul_bmp.height),this.endingTurn=!1,this.infl<0&&0==this.helpGiven)this.failsound.play(),this.popup.show(getString(this.language,"popup","inf_help","header"),getString(this.language,"popup","inf_help","string"),this.giveHelp,null);else if(this.infl<=-100){this.showCurtain(1,LAYER_TOOLTIP+1e3),this.phaser.input.enabled=!1,setTimeout(this.menu.showGameOver,500);for(var levelReached=1,i=0;i<this.town.constructions.length;i++)"hermans_ditch"==this.town.constructions[i]&&levelReached<2&&(levelReached=2),"trynka_channel"==this.town.constructions[i]&&levelReached<3&&(levelReached=3);gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Fail,"age"+levelReached),gameanalytics.GameAnalytics.addDesignEvent("game_over:turns",this.turn),gameanalytics.GameAnalytics.addDesignEvent("game_over:coins",this.money),gameanalytics.GameAnalytics.addDesignEvent("game_over:influence",this.infl),gameanalytics.GameAnalytics.addDesignEvent("game_over:age",levelReached),gameanalytics.GameAnalytics.addDesignEvent("game_over:difficulty",this.game.difficulty)}else this.deck.drawCards()}),_defineProperty(this,"giveHelp",()=>{this.helpGiven=!0;var fakePointer=new Object;fakePointer.x=50,fakePointer.y=300,this.pay(0,-50,fakePointer,!0,!1),this.endTurn5()}),_defineProperty(this,"requestPenalty",()=>{this.request.failRequest(),this.endTurn5()}),_defineProperty(this,"showTooltip2",txt=>{this.toolTipText.text=txt,this.toolTip.visible=!0,this.toolTipText.x=5,this.toolTipText.y=5,this.toolTipBackground.setOrigin(0),this.toolTipBackground.displayHeight=this.toolTipText.height+1+4,this.toolTipBackground.displayWidth=this.toolTipText.width+3+4,this.toolTipBackground.x=this.toolTipText.x-2-2,this.toolTipBackground.y=this.toolTipText.y+3-2}),_defineProperty(this,"showTooltip",txt=>{this.toolTipText.text=getString(this.language,"tooltip",txt,"string"),this.toolTip.visible=!0,this.toolTipText.x=5,this.toolTipText.y=5,this.toolTipBackground.setOrigin(0),this.toolTipBackground.displayHeight=this.toolTipText.height+1+4,this.toolTipBackground.displayWidth=this.toolTipText.width+3+4,this.toolTipBackground.x=this.toolTipText.x-2-2,this.toolTipBackground.y=this.toolTipText.y+3-2}),_defineProperty(this,"advanceTutorial",()=>{this.tutorial=Math.floor(this.tutorial),this.tutorial+=1,10==this.tutorial&&this.town.increasePopulation(1,!0,-1)}),_defineProperty(this,"showTutorial",(txt,x,y,arrowX,arrowY,arrowRotation,width)=>{""!=txt&&(txt=getString(this.language,"tutorial",txt,"string")),null==width&&(width=120),this.tutorialTip.visible=!0,this.tutorialTipText.text=txt,this.tutorialTipText.setMaxWidth(width),this.tutorialTip.visible=!0,this.tutorialTipText.x=5,this.tutorialTipText.y=5,this.tutorialTipBackground.setOrigin(0),this.tutorialTipBackground.displayHeight=this.tutorialTipText.height+1+4,this.tutorialTipBackground.displayWidth=this.tutorialTipText.width+3+4,this.tutorialTipBackground.x=this.tutorialTipText.x-2-2,this.tutorialTipBackground.y=this.tutorialTipText.y+3-2,this.tutorialTip.x=x,this.tutorialTip.y=y,this.tutorialTipArrow.setOrigin(.5,1),this.tutorialTipArrow.rotation=arrowRotation,this.tutorialTipArrow.x=arrowX,this.tutorialTipArrow.y=arrowY,this.tutorialTipArrow.visible=-1!=arrowX,this.tutorialTip.setDepth(LAYER_TUTORIAL-1)}),_defineProperty(this,"hideTooltip",()=>{this.toolTipText.setMaxWidth(120),this.toolTip.visible=!1}),_defineProperty(this,"flyMoney",(icon,x,y)=>{var fakeMoney=this.phaser.add.bitmapText(1,1,"numbers_font_white",icon),path,curve,points;fakeMoney.x=-100,fakeMoney.y=-100,fakeMoney.scale=1,fakeMoney.setDepth(LAYER_GUI),fakeMoney.alpha=1,path={t:0,vec:new Phaser.Math.Vector2};var startPoint=new Phaser.Math.Vector2(20,256),controlPoint1=new Phaser.Math.Vector2(GAME_WIDTH/3+20*Math.random(),GAME_HEIGHT/2+20*Math.random()),controlPoint2=new Phaser.Math.Vector2(GAME_WIDTH/3+20*Math.random(),GAME_HEIGHT/2+20*Math.random()),endPoint=new Phaser.Math.Vector2(x,y);points=(curve=new Phaser.Curves.CubicBezier(startPoint,controlPoint1,controlPoint2,endPoint)).getSpacedPoints(32),"@"==icon&&(startPoint.x+=100*Math.random()-10,startPoint.y+=40*Math.random()-20),this.phaser.tweens.add({targets:path,t:1,ease:"Sine.easeOut",duration:1e3,yoyo:!1,repeat:0,onUpdate:function(){curve.getPoint(path.t,path.vec),fakeMoney.x=path.vec.x,fakeMoney.y=path.vec.y},onUpdateScope:this,onComplete:function(){fakeMoney.destroy()},onCompleteScope:this})}),_defineProperty(this,"enableControl",()=>{this.phaser.input.enabled=!0}),_defineProperty(this,"saveGame",()=>{var saveObject=new Object;saveObject.money=this.money,saveObject.moneyGain=this.moneyGain,saveObject.infl=this.infl,saveObject.turn=this.turn,saveObject.tutorial=this.tutorial,saveObject.tutorialBuildBlocked=this.tutorialBuildBlocked,saveObject.tutorialConstructionInArchive=this.tutorialConstructionInArchive,saveObject.tutorialInfluenceOverOneHundred=this.tutorialInfluenceOverOneHundred,saveObject.tutorialMoveToShelf=this.tutorialMoveToShelf,saveObject.helpGiven=this.helpGiven,saveObject.wellBuilt=this.wellBuilt,saveObject.deck=this.deck.stack,saveObject.discarded=this.deck.discarded,saveObject.hand=[];for(var i=0;i<this.hand.cards.length;i++)saveObject.hand.push(this.hand.cards[i].id.toString());saveObject.difficulty=this.difficulty,saveObject.fireChance=this.fireChance,saveObject.requestChance=this.requestChance,saveObject.constructions=this.town.constructions,saveObject.columnWellPower=this.town.columnWellPower,saveObject.previousRequest=this.previousRequest,saveObject.townWorkersIds=[],saveObject.townWorkersBlocks=[];for(var i=0;i<this.town.walkers.length;i++)saveObject.townWorkersIds.push(this.town.walkers[i].id.toString()),saveObject.townWorkersBlocks.push(this.town.walkers[i].parentBlock.id.toString());saveObject.blocks=[],saveObject.fires=[];for(var i=0;i<this.town.blocks.length;i++)saveObject.blocks.push(this.town.blocks[i].demand),saveObject.fires.push(this.town.blocks[i].fire);saveObject.population=this.town.population,saveObject.constructionId=this.construction.constructionId,saveObject.requestId=this.request.constructionId,saveObject.constructionSlots=[];for(var i=0;i<this.construction.slots.length;i++)1==this.construction.slots[i].gotCard?saveObject.constructionSlots.push(this.construction.slots[i].fakeCard.id):saveObject.constructionSlots.push("");saveObject.requestTimer=this.request.timer,saveObject.requestSlots=[];for(var i=0;i<this.request.slots.length;i++)1==this.request.slots[i].gotCard?saveObject.requestSlots.push(this.request.slots[i].fakeCard.id):saveObject.requestSlots.push("");saveObject.pipes=[];for(var i=0;i<this.town.pipes.length;i++)""!=this.town.pipes[i].builtId&&saveObject.pipes.push(i);saveObject.wells=[],saveObject.wellsGain=[],saveObject.sumps=[];for(var i=0;i<this.town.nodes.length;i++)"well"==this.town.nodes[i].builtId&&(saveObject.wells.push(i),saveObject.wellsGain.push(this.town.nodes[i].gainWater1)),"sump"==this.town.nodes[i].builtId&&saveObject.sumps.push(i);saveObject.drawer1Level=this.drawer1.level,saveObject.drawer2Level=this.drawer2.level,saveObject.drawer3Level=this.drawer3.level,saveObject.drawer1=[],saveObject.drawer2=[],saveObject.drawer3=[];for(var j=0;j<this.drawer1.slots.length;j++)this.drawer1.slots[j].card?saveObject.drawer1.push(this.drawer1.slots[j].card.id):saveObject.drawer1.push("");for(var j=0;j<this.drawer2.slots.length;j++)this.drawer2.slots[j].card?saveObject.drawer2.push(this.drawer2.slots[j].card.id):saveObject.drawer2.push("");for(var j=0;j<this.drawer3.slots.length;j++)this.drawer3.slots[j].card?saveObject.drawer3.push(this.drawer3.slots[j].card.id):saveObject.drawer3.push("");isLocalStorage()&&localStorage.setItem("scriptwelder_waterworks_save",JSON.stringify(saveObject)),this.menu.saveState()}),_defineProperty(this,"loadGame",()=>{this.endingTurn=!0,this.alwaysShowSupplyDemand=!1,this.showPipes=0,this.town.hideSupplyDemand(),this.showSupplyButton.button.setTexture("gui","supply"),this.showSupplyButton.hover.setTexture("gui","supply_over"),this.town.hideWellPower(!0),this.showPipesButton.button.setTexture("gui","pipe"),this.showPipesButton.hover.setTexture("gui","pipe_over"),this.ambience1.play({mute:!1,volume:2,seek:0,loop:!0,delay:0});var saveObject=localStorage.getItem("scriptwelder_waterworks_save");for(saveObject=JSON.parse(saveObject);this.town.walkers.length>0;)this.town.walkers[0].kill(),this.town.walkers.shift();this.money=saveObject.money,this.moneyGain=saveObject.moneyGain,this.infl=saveObject.infl,this.turn=saveObject.turn,saveObject.difficulty?this.difficulty=saveObject.difficulty:this.difficulty=2,saveObject.wellBuilt&&(this.wellBuilt=saveObject.wellBuilt),this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=0,1==this.difficulty&&(this.difficultyPriceMod=.8,this.difficultyPopulationMod=1,this.difficultyCardsPerTurn=5),2==this.difficulty&&(this.difficultyPriceMod=1,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=5),3==this.difficulty&&(this.difficultyPriceMod=1.05,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=4,this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=0),4==this.difficulty&&(this.difficultyPriceMod=1.1,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=3,this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=2),this.tutorial=saveObject.tutorial,this.tutorialBuildBlocked=saveObject.tutorialBuildBlocked,this.tutorialConstructionInArchive=saveObject.tutorialConstructionInArchive,this.tutorialInfluenceOverOneHundred=saveObject.tutorialInfluenceOverOneHundred,this.tutorialMoveToShelf=saveObject.tutorialMoveToShelf,this.helpGiven=saveObject.helpGiven,this.deck.stack=saveObject.deck,this.deck.discarded=saveObject.discarded,null!=saveObject.previousRequest&&(this.previousRequest=saveObject.previousRequest),this.hand.discardHand(!1);for(var i=0;i<saveObject.hand.length;i++)this.hand.addCard(saveObject.hand[i]);this.fireChance=saveObject.fireChance,this.requestChance=saveObject.requestChance,this.town.constructions=saveObject.constructions,this.town.columnWellPower=saveObject.columnWellPower,this.town.walkers=[];for(var i=0;i<saveObject.townWorkersIds.length;i++)this.town.walkers.push(new Walker(this,saveObject.townWorkersIds[i],this.town.blocks[saveObject.townWorkersBlocks[i]],!1));for(var i=0;i<this.town.blocks.length;i++)this.town.blocks[i].demand=saveObject.blocks[i],this.town.blocks[i].fire=0,this.town.blocks[i].startFire(saveObject.fires[i]),this.town.blocks[i].updateSkin();for(var i=0;i<this.town.nodes.length;i++)this.town.nodes[i].builtId="";for(var i=0;i<this.town.pipes.length;i++)this.town.pipes[i].builtId="";this.construction.deleteConstruction(),this.construction.update(),this.request.deleteConstruction(),this.request.update(),""!=saveObject.constructionId&&(this.construction.startConstruction(saveObject.constructionId),this.construction.openCloseConstruction()),""!=saveObject.requestId&&(this.request.startConstruction(saveObject.requestId),this.request.openCloseConstruction(),this.request.timer=saveObject.requestTimer);for(var i=0;i<saveObject.constructionSlots.length;i++)""!=saveObject.constructionSlots[i]&&null!=saveObject.constructionSlots[i]&&(this.construction.slots[i].gotCard=!0,this.construction.slots[i].show());for(var i=0;i<saveObject.requestSlots.length;i++)""!=saveObject.requestSlots[i]&&null!=saveObject.requestSlots[i]&&(""!=this.request.slots[i].wantId?this.request.slots[i].gotCard=!0:(this.request.slots[i].gotCard=!0,this.request.slots[i].wantId=saveObject.requestSlots[i],this.request.slots[i].prepFakeCard(saveObject.requestSlots[i]),this.request.slots[i].position(this.request.slots[i].slotButton.x,this.request.slots[i].slotButton.y),this.request.slots[i].fakeCard.card.alpha=1,this.request.slots[i].gotCard=!0),this.request.slots[i].show());if(saveObject.pipes)for(var i=0;i<saveObject.pipes.length;i++)this.town.pipes[saveObject.pipes[i]].builtId="pipe";if(saveObject.wells)for(var i=0;i<saveObject.wells.length;i++)this.town.nodes[saveObject.wells[i]].builtId="well",saveObject.wellsGain&&(this.town.nodes[saveObject.wells[i]].gainWater1=saveObject.wellsGain[i]);if(saveObject.sumps)for(var i=0;i<saveObject.sumps.length;i++)this.town.nodes[saveObject.sumps[i]].builtId="sump";this.town.population=saveObject.population,this.drawer1.level=saveObject.drawer1Level,this.drawer2.level=saveObject.drawer2Level,this.drawer3.level=saveObject.drawer3Level,this.drawer1.emptyDrawer(),this.drawer2.emptyDrawer(),this.drawer3.emptyDrawer();for(var i=0;i<saveObject.drawer1.length;i++)""!=saveObject.drawer1[i]&&null!=saveObject.drawer1[i]&&this.drawer1.slots[i].grabACard(new Card(this.hand,saveObject.drawer1[i]));for(var i=0;i<saveObject.drawer2.length;i++)""!=saveObject.drawer2[i]&&null!=saveObject.drawer2[i]&&this.drawer2.slots[i].grabACard(new Card(this.hand,saveObject.drawer2[i]));for(var i=0;i<saveObject.drawer3.length;i++)""!=saveObject.drawer3[i]&&null!=saveObject.drawer3[i]&&this.drawer3.slots[i].grabACard(new Card(this.hand,saveObject.drawer3[i]));this.drawer1.update(),this.drawer2.update(),this.drawer3.update(),this.drawer1.open=!0,this.drawer2.open=!0,this.drawer3.open=!0,this.drawer1.openCloseQuiet(),this.drawer2.openCloseQuiet(),this.drawer3.openCloseQuiet(),this.hand.positionCards(),this.town.checkWaterPath(),this.town.updateSupply(),this.town.showSupplyDemand(),this.town.hideSupplyDemand(),this.fireloopsound.stop();for(var i=0;i<this.town.blocks.length;i++)if(this.town.blocks[i].fire>0){this.fireloopsound.play({loop:!0});break}this.calculatePerTurn(),this.displayedInfl=this.infl,this.displayedMoney=this.money,this.round_bmp.text=getString(this.language,"gui","turn","string")+" "+this.turn,this.popul_bmp.text="` +"+this.perTurn,this.round_bmp.input.hitArea.setSize(this.round_bmp.width,this.round_bmp.height),this.popul_bmp.input.hitArea.setSize(this.popul_bmp.width,this.popul_bmp.height),this.endingTurn=!1,this.sellButton.setVisible(!1),(0==this.options.tutorials||this.tutorial>=14)&&this.sellButton.setVisible(!0),this.showSupplyButton.setVisible(!1),(0==this.options.tutorials||this.tutorial>=4)&&this.showSupplyButton.setVisible(!0),this.showPipesButton.setVisible(!1),(0==this.options.tutorials||this.tutorial>=18)&&this.showPipesButton.setVisible(!0),this.deck.updateDeckNumber(),this.deck.updateStack(),this.updateLocks(),this.construction.update(),this.request.update(),this.options.operate(),this.setEverythingEnabled(!1),gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Start,"load_game"),gameanalytics.GameAnalytics.addDesignEvent("load_game:difficulty",this.difficulty),gameanalytics.GameAnalytics.addDesignEvent("load_game:turn",this.turn),gameanalytics.GameAnalytics.addDesignEvent("load_game:coins",this.money),gameanalytics.GameAnalytics.addDesignEvent("load_game:influence",this.infl)}),_defineProperty(this,"newGame",()=>{for(this.construction.rays1.visible=!1,this.construction.rays2.visible=!1,this.construction.rays3.visible=!1,this.construction.rays4.visible=!1,this.request.rays1.visible=!1,this.request.rays2.visible=!1,this.request.rays3.visible=!1,this.request.rays4.visible=!1,this.rays1.visible=!1,this.rays2.visible=!1,this.endingTurn=!0,this.alwaysShowSupplyDemand=!1,this.showPipes=0,this.town.hideSupplyDemand(),this.showSupplyButton.button.setTexture("gui","supply"),this.showSupplyButton.hover.setTexture("gui","supply_over"),this.town.hideWellPower(!0),this.showPipesButton.button.setTexture("gui","pipe"),this.showPipesButton.hover.setTexture("gui","pipe_over");this.town.walkers.length>0;)this.town.walkers[0].kill(),this.town.walkers.shift();this.turn=1,this.money=150,this.moneyGain=5,this.infl=30,this.previousRequest=-1,this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=0,1==this.difficulty&&(this.difficultyPriceMod=.8,this.difficultyPopulationMod=1,this.difficultyCardsPerTurn=5,this.infl=50),2==this.difficulty&&(this.difficultyPriceMod=1,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=5),3==this.difficulty&&(this.difficultyPriceMod=1.05,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=4,this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=0),4==this.difficulty&&(this.difficultyPriceMod=1.1,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=3,this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=2),this.tutorial=-2,this.tutorialBuildBlocked=-1,this.tutorialMoveToShelf=!1,this.tutorialConstructionInArchive=!1,this.helpGiven=!1,this.wellBuilt=!1,this.deck.stack=["water_source","worker","worker","permit","foreman"],this.deck.discarded=[],this.hand.discardHand(!1),this.fireChance=0,this.requestChance=0,this.town.constructions=[],this.town.columnWellPower=[0,0,0,0,0,0,0,0],this.town.population=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19],this.town.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19),this.town.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19),this.town.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19),this.fireloopsound.stop();for(var i=0;i<this.town.blocks.length;i++)this.town.blocks[i].demand=1,this.town.blocks[i].fire=0,this.town.blocks[i].startFire(0),this.town.blocks[i].updateSkin();for(;this.difficultyStartingPopulation2>0;){var temp=-1;do{temp=Math.floor(20*Math.random())}while(this.town.blocks[temp].demand>=2);this.town.blocks[temp].demand+=2,this.difficultyStartingPopulation2--;for(var j=0;j<2;j++)for(var i=0;i<this.town.population.length;i++)if(this.town.population[i]==temp){this.town.population.splice(i,1);break}}for(;this.difficultyStartingPopulation1>0;){var temp=-1;do{temp=Math.floor(20*Math.random())}while(this.town.blocks[temp].demand>=2);this.town.blocks[temp].demand+=1,this.difficultyStartingPopulation1--;for(var i=0;i<this.town.population.length;i++)if(this.town.population[i]==temp){this.town.population.splice(i,1);break}}this.construction.deleteConstruction(),this.construction.update(),this.request.deleteConstruction(),this.request.update();for(var i=0;i<this.town.nodes.length;i++)this.town.nodes[i].builtId="";for(var i=0;i<this.town.pipes.length;i++)this.town.pipes[i].builtId="";this.drawer1.level=0,this.drawer2.level=0,this.drawer3.level=0,this.drawer1.emptyDrawer(),this.drawer2.emptyDrawer(),this.drawer3.emptyDrawer(),this.drawer1.update(),this.drawer2.update(),this.drawer3.update(),this.drawer1.open=!0,this.drawer2.open=!0,this.drawer3.open=!0,this.drawer1.openCloseQuiet(),this.drawer2.openCloseQuiet(),this.drawer3.openCloseQuiet(),this.hand.positionCards(),this.round_bmp.text=getString(this.language,"gui","turn","string")+" "+this.turn,this.popul_bmp.text="` +"+this.perTurn,this.round_bmp.input.hitArea.setSize(this.round_bmp.width,this.round_bmp.height),this.popul_bmp.input.hitArea.setSize(this.popul_bmp.width,this.popul_bmp.height),this.town.checkWaterPath(),this.town.updateSupply(),this.town.showSupplyDemand(),this.town.hideSupplyDemand();for(var i=0;i<this.town.blocks.length;i++)if(this.town.blocks[i].fire>0){this.fireloopsound.play({loop:!0});break}this.options.operate(),this.setEverythingEnabled(!1),this.endTurnButton.setVisible(!1),this.sellButton.setVisible(!1),this.showSupplyButton.setVisible(!1),this.showPipesButton.setVisible(!1),setTimeout(this.startGame,2e3),this.deck.updateDeckNumber(),this.deck.updateStack(),this.perTurn=1,this.endingTurn=!1,this.calculatePerTurn(),this.nothingToDo=!1,gameanalytics.GameAnalytics.addProgressionEvent(gameanalytics.EGAProgressionStatus.Start,"new_game"),gameanalytics.GameAnalytics.addDesignEvent("new_game:difficulty",this.difficulty)}),_defineProperty(this,"update",(time,delta)=>{if(this.phaser.scale.isFullscreen?(this.options.fullScreen=!0,this.options.btnFullScreenOff.setFont("text_black"),this.options.btnFullScreenOn.setFont("text_white2")):(this.options.fullScreen=!1,this.options.btnFullScreenOff.setFont("text_white2"),this.options.btnFullScreenOn.setFont("text_black")),this.menu.container.visible&&this.currentMusic?this.currentMusic.volume=1:this.currentMusic&&(this.currentMusic.volume=.75),!this.paused&&!this.menu.container.visible){if(this.town){if(delta>1e3&&(delta=1e3),this.timeTillNextSound-=delta,this.timeTillNextSound<=0){this.timeTillNextSound=5e3+1e4*Math.random();var possibleSounds=[];possibleSounds.push(this.ambient_barking),possibleSounds.push(this.ambient_blacksmith),possibleSounds.push(this.ambient_chicken),possibleSounds.push(this.ambient_cow),possibleSounds.push(this.ambient_cow2),possibleSounds.push(this.ambient_kids),possibleSounds.push(this.ambient_market),possibleSounds.push(this.ambient_market2),possibleSounds.push(this.ambient_market3),possibleSounds.push(this.ambient_rooster),possibleSounds.push(this.ambient_sweep),possibleSounds.push(this.ambient_scribble),possibleSounds.push(this.ambient_pickaxe),possibleSounds.push(this.ambient_wooden),possibleSounds.push(this.ambient_latch),possibleSounds.push(this.ambient_latch2),possibleSounds.push(this.ambient_nailed),possibleSounds.push(this.ambient_crow),possibleSounds.push(this.ambient_bird);for(var i=0;i<this.town.walkers.length;i++)if("water_wagon"==this.town.walkers[i].id){possibleSounds.push(this.ambient_wagon1),possibleSounds.push(this.ambient_wagon2);break}for(var i=0;i<this.town.walkers.length;i++)if("water_cart"==this.town.walkers[i].id){possibleSounds.push(this.ambient_cart),possibleSounds.push(this.ambient_cart2);break}this.town.blocks[15].demand>=6&&possibleSounds.push(this.ambient_bells),this.town.blocks[15].demand>=6&&possibleSounds.push(this.ambient_bells2);var random=Math.floor(Math.random()*possibleSounds.length);possibleSounds[random]!=this.last_ambient&&possibleSounds[random].play({mute:!1,volume:.15+.45*Math.random(),rate:.9+.2*Math.random(),detune:300*Math.random()-150,seek:0,loop:!1,delay:0}),this.last_ambient=possibleSounds[random]}this.town,this.const_bmp.text=this.town.constructions.length;for(var i=0;i<this.town.walkers.length;i++)this.town.walkers[i].update(time,delta);if(this.tutorialTip.visible=!1,0==this.tutorial){for(var locX=0,locY=0,rot=0,ok=!1,j=0;j<this.hand.cards.length;j++)if("water_source"==this.hand.cards[j].id){ok=!0,locX=this.hand.cards[j].card.x,locY=92+this.hand.cards[j].cardInner.y+10,this.selectedItem==this.hand.cards[j]&&(rot=Math.PI,locY-=50);break}0==ok&&0==this.tutorial?this.tutorial=1:this.showTutorial("0",locX+20,190,-20,locY,rot)}else if(1==this.tutorial){if(this.construction.open){var locX=300,locY=-50;0==this.construction.slots[0].gotCard?(locX=300,locY=-50):(1==this.construction.slots[0].gotCard&&(locX=300+CARD_WIDTH),1==this.construction.slots[1].gotCard&&(locX=300+2*CARD_WIDTH),1==this.construction.slots[2].gotCard&&(locX=300+CARD_WIDTH,locY=-50+CARD_SMALL_HEIGHT)),this.showTutorial("1",10,200,locX,locY,Math.PI),1==this.construction.slots[0].gotCard&&1==this.construction.slots[1].gotCard&&1==this.construction.slots[2].gotCard&&1==this.construction.slots[3].gotCard&&1==this.tutorial&&(this.tutorial=2)}}else if(2==this.tutorial)this.construction.open&&this.showTutorial("2",10,200,120,-120,Math.PI);else if(3==this.tutorial&&0==this.popup.container.visible)this.tutorial=3.5,this.popup.show(getString(this.language,"popup","tutorial_3","header"),getString(this.language,"popup","tutorial_3","string"),this.advanceTutorial,null);else if(4==this.tutorial)this.showSupplyButton.setVisible(!0),this.showTutorial("4",this.showSupplyButton.button.x-150,this.showSupplyButton.button.y+20,150,-10,Math.PI);else if(5==this.tutorial)this.showTutorial("5",50,260,-1,0,0,500);else if(6==this.tutorial)this.showTutorial("6",50,260,465,-240,.5*Math.PI,500);else if(7==this.tutorial)this.showTutorial("7",415,250,180,70,-.5*Math.PI);else if(11==this.tutorial){for(var locX=0,locY=0,rot=0,ok=!1,j=this.hand.cards.length-1;j>=0;j--)if("water_carrier"==this.hand.cards[j].id){ok=!0,locX=this.hand.cards[j].card.x,locY=92+this.hand.cards[j].cardInner.y+10,this.selectedItem==this.hand.cards[j]&&(rot=Math.PI,locY-=50);break}this.showTutorial("11",locX+20,190,-20,locY,rot)}else 12==this.tutorial?0==this.town.walkers.length?this.showTutorial("12",120,290,-1,0,0,500):this.showTutorial("12",120,270,this.town.walkers[0].x-110,this.town.walkers[0].y-270,.5*Math.PI,500):14==this.tutorial||15==this.tutorial?(14==this.tutorial&&this.popup.show(getString(this.language,"popup","tutorial_14","header"),getString(this.language,"popup","tutorial_14","string"),this.advanceTutorial,null),this.tutorial=15,this.sellButton.setVisible(!0),this.showTutorial("",this.sellButton.button.x-100,this.sellButton.button.y+20,105,-15,.5*Math.PI,200)):16==this.tutorial?(this.tutorial=17,this.phaser.input.enabled=!1,setTimeout((function(t){t.phaser.input.enabled=!0}),500,this),this.popup.show(getString(this.language,"popup","tutorial_16","header"),getString(this.language,"popup","tutorial_16","string"),null,null),this.endTurnButton.setVisible(!0),this.updateLocks()):18==this.tutorial?(this.endTurnButton.setVisible(!1),this.showPipesButton.setVisible(!0),this.showTutorial("18",this.showPipesButton.button.x-150,this.showPipesButton.button.y+20,150,-10,Math.PI)):19==this.tutorial&&(this.endTurnButton.setVisible(!1),this.showTutorial("19",this.showPipesButton.button.x-150,this.showPipesButton.button.y+100,150,-10,Math.PI));this.town.watersource.visible=!1,this.town.watersource2.visible=!1,(this.tutorial<7||this.tutorial>7&&this.tutorial<100&&17!=this.tutorial)&&this.endTurnButton.setVisible(!1);for(var waterworks=0,water_source=0,stable=0,carts=!1,i=0;i<this.town.constructions.length;i++){"upgraded_water_source"==this.town.constructions[i]?(water_source=2,this.town.watersource.visible=!1,this.town.watersource2.visible=!0):"water_source"==this.town.constructions[i]&&water_source<2&&(water_source=1,this.town.watersource.visible=!0,this.town.watersource2.visible=!1,2==this.tutorial&&(this.tutorial=3),7==this.tutorial&&this.endTurnButton.setVisible(!0)),"carts"==this.town.constructions[i]&&(carts=!0),"stable2"==this.town.constructions[i]?stable=2:"stable"==this.town.constructions[i]&&stable<2&&(stable=1),"waterworks"==this.town.constructions[i]&&waterworks++;for(var j=2;j<=5;j++)this.town.constructions[i]=="waterworks"+j&&waterworks++;"adv_sumps"==this.town.constructions[i]&&waterworks++,"adv_pipes"==this.town.constructions[i]&&waterworks++,"heated_water_tower"==this.town.constructions[i]&&waterworks++}if(this.town.waterworks.visible=!1,1==waterworks&&(this.town.waterworks.visible=!0,"waterworks1"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks1"),this.town.columnWellPower=[1,1,2,2,3,3,4,4],this.town.waterworks.x=545),2==waterworks&&(this.town.waterworks.visible=!0,"waterworks2"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks2"),this.town.columnWellPower=[3,3,4,4,5,5,5,5],this.town.waterworks.x=545),3==waterworks&&(this.town.waterworks.visible=!0,"waterworks3"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks3"),this.town.columnWellPower=[5,5,6,6,6,6,6,6],this.town.waterworks.x=545),4==waterworks&&(this.town.waterworks.visible=!0,"waterworks4"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks4"),this.town.columnWellPower=[7,7,7,7,7,7,7,7],this.town.waterworks.x=540),5==waterworks&&(this.town.waterworks.visible=!0,"waterworks4"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks4"),this.town.columnWellPower=[8,8,8,8,8,8,8,8],this.town.waterworks.x=540),6==waterworks&&(this.town.waterworks.visible=!0,"waterworks4"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks4"),this.town.columnWellPower=[9,9,9,9,9,9,9,9],this.town.waterworks.x=540),7==waterworks&&(this.town.waterworks.visible=!0,"waterworks4"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks4"),this.town.columnWellPower=[10,10,10,10,10,10,10,10],this.town.waterworks.x=540),8==waterworks&&(this.town.waterworks.visible=!0,"waterworks4"!=this.town.waterworks.anims.currentAnim.key&&this.town.waterworks.play("waterworks4"),this.town.columnWellPower=[11,11,11,11,11,11,11,11],this.town.waterworks.x=540),2==stable){var tex=this.phaser.textures.get("stable");this.town.stable.setTexture("stable","stable2"),this.town.stable.x=tex.frames.stable2.customData.spriteSourceSize.x+8,this.town.stable.y=tex.frames.stable2.customData.spriteSourceSize.y-3,this.town.stable.visible=!0,this.town.horse.visible=!0}else if(1==stable){var tex=this.phaser.textures.get("stable");this.town.stable.setTexture("stable","stable1"),this.town.stable.x=tex.frames.stable1.customData.spriteSourceSize.x+8,this.town.stable.y=tex.frames.stable1.customData.spriteSourceSize.y-3,this.town.stable.visible=!0,this.town.horse.visible=!0}else this.town.stable.visible=!1,this.town.horse.visible=!1;for(var sum=0,i=0;i<this.town.blocks.length;i++)sum+=this.town.blocks[i].demand;if(1==carts){this.town.water_road.visible=!0;var tex=this.phaser.textures.get("water_road");sum>100?(this.town.water_road.setTexture("water_road","water_road_b"),this.town.water_road.x=tex.frames.water_road_b.customData.spriteSourceSize.x,this.town.water_road.y=tex.frames.water_road_b.customData.spriteSourceSize.y):(this.town.water_road.setTexture("water_road","water_road_a"),this.town.water_road.x=tex.frames.water_road_a.customData.spriteSourceSize.x,this.town.water_road.y=tex.frames.water_road_a.customData.spriteSourceSize.y)}else this.town.water_road.visible=!1;if(this.town.boat.x-=this.town.boatSpeed*delta*.01*1,this.town.boat.x<-200){this.town.boat.x=700+20*Math.random(),this.town.boat.y=365-20*Math.random(),this.town.boat.y=350,this.town.boatSpeed=1+2*Math.random();var possibleBoats=["boat1"];sum>40&&(possibleBoats.push("boat2"),possibleBoats.push("boat3")),sum>100&&(possibleBoats.push("boat4"),possibleBoats.push("boat5"));do{var nam=possibleBoats[Math.floor(possibleBoats.length*Math.random())]}while(possibleBoats.length>1&&nam==this.town.previousBoat);this.town.previousBoat=nam,"boat1"==nam&&(this.town.boatSpeed*=.75),this.town.boat.play(nam)}sum>=80?(sum>160?"mill2"!=this.town.mill.anims.currentAnim.key&&this.town.mill.play("mill2"):"mill1"!=this.town.mill.anims.currentAnim.key&&this.town.mill.play("mill1"),this.town.mill.visible=!0):this.town.mill.visible=!1,sum>=120?(this.town.bridge1.visible=!1,this.town.bridge2.visible=!0,"waterunderthebridge2"!=this.town.waterunderthebridge.anims.currentAnim.key&&this.town.waterunderthebridge.play("waterunderthebridge2")):(this.town.bridge1.visible=!0,this.town.bridge2.visible=!1,"waterunderthebridge1"!=this.town.waterunderthebridge.anims.currentAnim.key&&this.town.waterunderthebridge.play("waterunderthebridge1"));for(var i=0;i<9;i++){var a=!1;sum>100+10*i&&(a=!0),this.town.walls[2*i].visible=!a,this.town.wallsShadows[2*i].visible=!a,this.town.walls[2*i+1].visible=a,this.town.wallsShadows[2*i+1].visible=a}}this.construction.rays1.visible=!1,this.construction.rays2.visible=!1,this.construction.rays3.visible=!1,this.construction.rays4.visible=!1,this.request.rays1.visible=!1,this.request.rays2.visible=!1,this.request.rays3.visible=!1,this.request.rays4.visible=!1,this.rays1.visible=!1,this.rays2.visible=!1,0==this.endingTurn&&0==this.isDrawingCards&&(1==this.construction.readyToBuild&&(this.construction.open?(this.construction.rays1.visible=!0,this.construction.rays2.visible=!0):(this.construction.rays3.visible=!0,this.construction.rays4.visible=!0)),1==this.request.readyToBuild&&(this.request.open?(this.request.rays1.visible=!0,this.request.rays2.visible=!0):(this.request.rays3.visible=!0,this.request.rays4.visible=!0)),this.nothingToDo&&this.tutorial>=6&&this.tutorial<200&&12!=this.tutorial&&13!=this.tutorial&&14!=this.tutorial?(this.rays1.visible=!0,this.rays2.visible=!0):(this.rays1.visible=!1,this.rays2.visible=!1)),0==this.endingTurn&&this.inflHit100&&this.options.tutorials&&0==this.tutorialInfluenceOverOneHundred&&0==this.popup.container.visible&&(this.tutorialInfluenceOverOneHundred=!0,this.popup.show(getString(this.language,"popup","inf_over_100","header"),getString(this.language,"popup","inf_over_100","string"),null,null))}}),_defineProperty(this,"playMusic",()=>{var delay=2;this.currentMusic&&(this.currentMusic.stop(),delay=60*Math.random(),this.menu&&this.menu.container.visible&&(delay=0));do{if(null==this.currentMusic||this.menu&&this.menu.container.visible)this.currentMusic=this.music3;else{var l=Math.random();this.currentMusic=l>.75?this.music0:l>.5?this.music1:l>.25?this.music2:this.music3}}while(!(this.currentMusic!=this.previousMusic||this.menu&&this.menu.container.visible));this.previousMusic=this.currentMusic,this.currentMusic.once("complete",this.playMusic);var mute=!1;this.options&&(mute=!this.options.music),this.currentMusic.play({mute:mute,volume:1,seek:0,loop:!1,delay:delay})}),_defineProperty(this,"victory",()=>{this.showCurtain(1,LAYER_TOOLTIP+1e3),this.phaser.input.enabled=!1,setTimeout(this.menu.showVictory,500)}),_defineProperty(this,"floatText",(text,fakePointer,randoX,randoY)=>{this.cost_bmp=this.phaser.add.bitmapText(1,25,"text_white",text),this.cost_bmp.setDepth(3e3),null!=randoX&&(randoX=-randoX+Math.random()*randoX*2),null!=randoY&&(randoY=-randoY+Math.random()*randoY*2),this.cost_bmp.alpha=1,this.cost_bmp.setCenterAlign(),this.cost_bmp.x=fakePointer.x+randoX,this.cost_bmp.y=fakePointer.y-20+randoY;var szer=this.cost_bmp.width/2;this.cost_bmp.scale=0,this.phaser.tweens.add({targets:this.cost_bmp,scale:1,x:this.cost_bmp.x-szer,ease:"Quad.Out",duration:200}),this.phaser.tweens.add({targets:this.cost_bmp,y:this.cost_bmp.y-50,ease:"Quad.Out",duration:4e3}),this.phaser.tweens.add({targets:this.cost_bmp,alpha:0,ease:"Quad.Out",duration:2e3,delay:2e3,onComplete:function(){this.targets[0].destroy()}})});var phaser=p,self=this;this.phaser=phaser,this.buyDetune=-20,this.infDetune=-50,this.infDetune2=-50,this.paused=!1,this.ambience1=this.phaser.sound.add("ambience1"),this.music0=this.phaser.sound.add("music0"),this.music1=this.phaser.sound.add("music1"),this.music2=this.phaser.sound.add("music2"),this.music3=this.phaser.sound.add("music3"),this.ambience1.loop=!0,this.ambience1.stop(),this.populationIncreaseConstructions=[],this.ach_coins=!1,this.ach_fortune=!1,this.ach_hermans=!1,this.ach_requests=!1,this.ach_s1=!1,this.ach_s2=!1,this.ach_s3=!1,this.ach_time=!1,this.ach_trynka=!1,this.ach_well=!1,this.ach_coins_count=0,this.ach_requests_count=0,this.ach_fortune_count=0,this.currentMusic=null,this.previousMusic=null,this.deny=this.phaser.sound.add("deny"),this.failsound=this.phaser.sound.add("fail"),this.notifysound=this.phaser.sound.add("notify"),this.fanfaresound=this.phaser.sound.add("fanfare"),this.firealarmsound=this.phaser.sound.add("fire"),this.fireloopsound=this.phaser.sound.add("fireloop"),this.clockSound=this.phaser.sound.add("clock"),this.last_ambient=null,this.ambient_barking=this.phaser.sound.add("barking"),this.ambient_bells=this.phaser.sound.add("bells"),this.ambient_bells2=this.phaser.sound.add("bells"),this.ambient_wagon1=this.phaser.sound.add("wagon1"),this.ambient_wagon2=this.phaser.sound.add("wagon2"),this.ambient_chicken=this.phaser.sound.add("chicken"),this.ambient_market=this.phaser.sound.add("market1"),this.ambient_market2=this.phaser.sound.add("market2"),this.ambient_market3=this.phaser.sound.add("market3"),this.ambient_blacksmith=this.phaser.sound.add("blacksmith"),this.ambient_kids=this.phaser.sound.add("kids"),this.ambient_rooster=this.phaser.sound.add("rooster"),this.ambient_cow=this.phaser.sound.add("cow"),this.ambient_cow2=this.phaser.sound.add("cow"),this.ambient_cart=this.phaser.sound.add("cart"),this.ambient_cart2=this.phaser.sound.add("cart"),this.ambient_sweep=this.phaser.sound.add("sweep"),this.ambient_scribble=this.phaser.sound.add("scribble"),this.ambient_pickaxe=this.phaser.sound.add("pickaxe"),this.ambient_wooden=this.phaser.sound.add("wooden"),this.ambient_latch=this.phaser.sound.add("latch"),this.ambient_latch2=this.phaser.sound.add("latch"),this.ambient_nailed=this.phaser.sound.add("nailed"),this.ambient_crow=this.phaser.sound.add("crow"),this.ambient_bird=this.phaser.sound.add("bird"),this.gainSound=this.phaser.sound.add("incomegain"),this.town=null,this.inflHit100=!1,this.selectedItem=null,this.selectedSpot=null,this.isInOptions=!1,this.isDrawingCards=!1,this.isUpdatingHand=!1,this.isDraggingCard=!1,this.isDroppingCard=!1,this.isDraggingWalker=!1,this.isDroppingWalker=!1,phaser.input.dragDistanceThreshold=8,this.isTargetingBlocks=!1,this.isTargetingStreets=!1,this.isTargetingNodes=!1,this.isTargetingGlobal=!1,this.alwaysShowSupplyDemand=!1,this.isShowingGains=!1,this.endingTurn=!1,this.nothingToDo=!1,this.rightClickedCardFly=null,this.flyingCard=null,this.isBulldozer=!1,this.endedTurn=0,this.clickMode=!1,this.justSelected=!1,this.timeTillNextSound=5e3+5e3*Math.random(),this.discarded=[],this.deleted=[],this.tutorial=-2,this.tutorialBuildBlocked=-1,this.tutorialMoveToShelf=!1,this.tutorialConstructionInArchive=!1,this.tutorialInfluenceOverOneHundred=!1,this.helpGiven=!1,this.wellBuilt=!1,this.toolTipText=this.phaser.add.bitmapText(1,1,"text_white","TOOLTIP"),this.toolTipBackground=this.phaser.add.image(0,0,"shade"),this.toolTipBackground.alpha=.75,this.toolTip=this.phaser.add.container(0,0,[this.toolTipBackground,this.toolTipText]),this.toolTipText.setMaxWidth(120),this.toolTip.setDepth(LAYER_TOOLTIP),this.hideTooltip(),this.tutorialTipText=this.phaser.add.bitmapText(1,1,"text_white","TOOLTIP"),this.tutorialTipBackground=this.phaser.add.image(0,0,"shade"),this.tutorialTipArrow=this.phaser.add.image(0,0,"gui","arrow"),this.tutorialTipBackground.alpha=.75,this.tutorialTip=this.phaser.add.container(0,0,[this.tutorialTipBackground,this.tutorialTipText,this.tutorialTipArrow]),this.tutorialTip.setDepth(LAYER_TUTORIAL),this.tutorialTipArrow.visible=!1,this.tutorialTip.visible=!1,this.showPipes=0,this.language="en",this.particles=this.phaser.add.particles("pixel").setDepth(9999).createEmitter({alpha:{start:1,end:0},scale:{start:.5,end:1.5},speed:{min:-80,max:80},angle:{min:-180,max:180},rotation:{min:-180,max:180},blendMode:"ADD",lifespan:{min:100,max:500},frequency:-1,x:GAME_WIDTH/2,y:GAME_HEIGHT/2}),this.hand=new Hand(this),this.turn=1,this.perTurn=1,this.money=75,this.moneyGain=5,this.displayedMoney=this.money,this.infl=30,this.displayedInfl=this.infl,this.moneyCounter=null,this.inflCounter=[],this.difficultyPriceMod=1,this.difficultyStartingPopulation2=0,this.difficultyStartingPopulation1=0,this.difficultyPopulationMod=2,this.difficultyCardsPerTurn=5,this.fireChance=0,this.requestChance=0,this.town=new Town(this),this.town.makeTown(),this.notification=new AchNotify(this),this.requests=[],this.previousRequest=-1;for(var xmlData=this.phaser.cache.xml.get("constructions").getElementsByTagName("construction"),i=0;i<xmlData.length;i++)"true"==xmlData[i].getAttribute("request")&&this.requests.push(xmlData[i]);if(this.curtain=phaser.add.image(0,0,"shade"),this.curtain.setOrigin(0),this.curtain.displayWidth=GAME_WIDTH,this.curtain.displayHeight=GAME_HEIGHT,this.curtain.alpha=1,this.curtain.setDepth(LAYER_CURTAIN),this.curtain.setInteractive(),isLocalStorage())var blob=localStorage.getItem("scriptwelder_waterworks_save");this.deck=new Deck(this),this.setEverythingEnabled(!1),this.moneybag=this.phaser.add.image(55,50,"gui","moneybag_cursor"),this.moneybag.setDepth(LAYER_GUI),this.moneybag.setOrigin(.25),this.moneybag.visible=!1,this.buttonsHolder=this.phaser.add.image(0,0,"gui","buttons_holder"),this.buttonsHolder.setOrigin(0);var tex=this.phaser.textures.get("gui");this.buttonsHolder.x=tex.frames.buttons_holder.customData.spriteSourceSize.x,this.buttonsHolder.y=tex.frames.buttons_holder.customData.spriteSourceSize.y,this.buttonsHolder.setDepth(LAYER_GUI_LOW-1),this.sellButton=new Button(this,"moneybag2","moneybag2_down","gui",this.sellButtonClick),this.sellButton.tooltip="sell",this.sellButton.setPosition(18,170),this.sellButton.setVisible(!1),this.sellButton.button.setDepth(LAYER_GUI_LOW),this.sellButton.hover.setDepth(LAYER_GUI_LOW+1),this.optionsButton=new Button(this,"gear0","gear1","gui",this.optionsButtonClick),this.optionsButton.tooltip="options",this.optionsButton.setPosition(9,9),this.optionsButton.setVisible(!0),this.optionsButton.button.setDepth(LAYER_GUI_LOW),this.optionsButton.hover.setDepth(LAYER_GUI_LOW+1),this.showPipesButton=new Button(this,"pipe","pipe_over","gui",this.pipeButtonClick),this.showPipesButton.tooltip="show_pipes",this.showPipesButton.setPosition(549,12),this.showPipesButton.setVisible(!1),this.showPipesButton.button.setDepth(LAYER_GUI_LOW),this.showPipesButton.hover.setDepth(LAYER_GUI_LOW+1),this.showSupplyButton=new Button(this,"supply","supply_over","gui",this.supplyButtonClick),this.showSupplyButton.tooltip="show_supply",this.showSupplyButton.setPosition(511,12),this.showSupplyButton.setVisible(!1),this.showSupplyButton.button.setDepth(LAYER_GUI_LOW),this.showSupplyButton.hover.setDepth(LAYER_GUI_LOW+1),this.endTurnButton=new Button(this,"hourglass_anim10","hourglass_down","gui",this.endTurnClick),this.endTurnButton.tooltip="end_turn",this.endTurnButton.button.setDepth(LAYER_GUI),this.endTurnButton.hover.setDepth(LAYER_GUI+1),this.endTurnButton.setPosition(GAME_WIDTH-this.endTurnButton.button.width/2+10,GAME_HEIGHT-32),this.rays1=this.phaser.add.image(0,0,"gui","rays1"),this.rays2=this.phaser.add.image(0,0,"gui","rays2"),this.rays1.x=this.endTurnButton.button.x,this.rays1.y=this.endTurnButton.button.y,this.rays2.x=this.endTurnButton.button.x,this.rays2.y=this.endTurnButton.button.y,this.rays1.setDepth(LAYER_GUI-1),this.rays2.setDepth(LAYER_GUI-1),this.rays1.scale=.9,this.rays2.scale=.9,this.phaser.tweens.add({targets:[this.rays1],rotation:2*Math.PI,duration:5e3,repeat:-1}),this.phaser.tweens.add({targets:[this.rays2],rotation:-2*Math.PI,duration:5e3,repeat:-1}),this.rays1.visible=!1,this.rays2.visible=!1,this.setDefaultEnabled(),this.construction=new Construction(this,0),this.request=new Construction(this,1),this.drawer1=new Drawer(this,CARD_TYPE_DOCUMENT),this.drawer2=new Drawer(this,CARD_TYPE_COMPONENT),this.drawer3=new Drawer(this,CARD_TYPE_WORKER),this.popup=new Popup(this),this.round_bmp=phaser.add.bitmapText(25,1,"text_white2",getString(this.language,"gui","turn","string")+" "+this.turn),this.popul_bmp=phaser.add.bitmapText(65,1,"text_white2","`"),this.const_bmp=phaser.add.bitmapText(102,1,"text_white2","1"),this.money_bmp=phaser.add.bitmapText(1,19,"numbers_font_white","@"+this.money),this.infl_bmp=phaser.add.bitmapText(1,33,"numbers_font_white","#"+this.infl),this.infl_bmp0=phaser.add.bitmapText(1,33,"numbers_font_white","#"),this.money2_bmp=phaser.add.bitmapText(1,21,"text_white2"," "),this.infl2_bmp=phaser.add.bitmapText(1,36,"text_white2"," "),this.round_bmp.setInteractive({cursor:"pointer"}),this.round_bmp.input.useHandCursor=!0,this.round_bmp.on("pointerover",(function(pointer){var diff="diff_normal";1==self.difficulty&&(diff="diff_easy"),3==self.difficulty&&(diff="diff_hard"),4==self.difficulty&&(diff="diff_hard2"),self.showTooltip2(getString(self.language,"tooltip","diff_level","string")+" "+getString(self.language,"gui",diff,"string")+"\n\n"+getString(self.language,"tooltip","round_info1","string")+" "+self.turn+" "+getString(self.language,"tooltip","round_info2","string"))})),this.round_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.popul_bmp.setInteractive({cursor:"pointer"}),this.popul_bmp.input.useHandCursor=!0,this.popul_bmp.on("pointerover",(function(pointer){self.showTooltip2(getString(self.language,"tooltip","popul_info1","string")+"  "+self.perTurn+" "+getString(self.language,"tooltip","popul_info2","string"))})),this.popul_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.money_bmp.setInteractive({cursor:"pointer"}),this.money_bmp.input.useHandCursor=!0,this.money_bmp.on("pointerover",(function(pointer){self.showTooltip2(getString(self.language,"tooltip","money_info1","string")+""+self.money+getString(self.language,"tooltip","money_info2","string")+self.moneyGain+" "+getString(self.language,"tooltip","money_info3","string"))})),this.money_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.infl_bmp.setInteractive({cursor:"pointer"}),this.infl_bmp.input.useHandCursor=!0,this.infl_bmp.on("pointerover",(function(pointer){self.showTooltip2(getString(self.language,"tooltip","infl_info1","string")+""+self.infl+getString(self.language,"tooltip","infl_info2","string")+self.town.calculateInflGain()+getString(self.language,"tooltip","infl_info3","string"))})),this.infl_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.money2_bmp.setInteractive({cursor:"pointer"}),this.money2_bmp.input.useHandCursor=!0,this.money2_bmp.on("pointerover",(function(pointer){self.showTooltip2(getString(self.language,"tooltip","money_info1","string")+""+self.money+getString(self.language,"tooltip","money_info2","string")+self.moneyGain+" "+getString(self.language,"tooltip","money_info3","string"))})),this.money2_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.infl2_bmp.setInteractive({cursor:"pointer"}),this.infl2_bmp.input.useHandCursor=!0,this.infl2_bmp.on("pointerover",(function(pointer){self.showTooltip2(getString(self.language,"tooltip","infl_info1","string")+""+self.infl+getString(self.language,"tooltip","infl_info2","string")+self.town.calculateInflGain()+getString(self.language,"tooltip","infl_info3","string"))})),this.infl2_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.const_bmp.setInteractive({cursor:"pointer"}),this.const_bmp.input.useHandCursor=!0,this.const_bmp.on("pointerover",(function(pointer){var str=getString(self.language,"tooltip","constructions_list","string")+"\n\n";if(0==self.town.constructions.length)str+=getString(self.language,"tooltip","constructions_none","string");else for(var i=0;i<self.town.constructions.length;i++)str+=getString(self.language,"construction",self.town.constructions[i],"name")+"\n";self.toolTipText.setMaxWidth(240),self.showTooltip2(str)})),this.const_bmp.on("pointerout",(function(pointer){self.hideTooltip()})),this.const_bmp.input.hitArea.setSize(30,20),this.const_bmp.input.hitArea.setPosition(-15,0),this.round_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.popul_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.money_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.infl_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.infl_bmp0.setDepth(LAYER_MONEY_INF_COUNTER+1),this.money2_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.infl2_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.const_bmp.setDepth(LAYER_MONEY_INF_COUNTER),this.playMusic(),this.menu=new MainMenu(this),this.options=new Options(this),this.options.container.visible=!1,this.menu.updateLanguage(),this.phaser.tweens.killTweensOf(this.curtain),this.curtain.alpha=1,this.showCurtain(1,LAYER_TOOLTIP+1e3),this.phaser.input.on("pointermove",(function(pointer,gameObject,event){var canvW=self.phaser.scale.canvasBounds.width;canvW<1&&(canvW=1),self.moneybag.x=pointer.x,self.moneybag.y=pointer.y,self.toolTip.x=pointer.x+1280/canvW*5,self.toolTip.y=pointer.y+1280/canvW*5,self.toolTip.x+self.toolTipBackground.displayWidth+self.toolTipBackground.x>GAME_WIDTH&&(self.toolTip.x=GAME_WIDTH-self.toolTipBackground.displayWidth-self.toolTipBackground.x),self.toolTip.y+self.toolTipBackground.displayHeight+self.toolTipBackground.y>GAME_HEIGHT&&(self.toolTip.y=GAME_HEIGHT-self.toolTipBackground.displayHeight-self.toolTipBackground.y),1==pointer.id&&(self.moneybag.visible=!1),null!=gameObject&&null!=gameObject[0]&&null!=gameObject[0].input||self.hideTooltip(),0!=self.clickMode&&(self.selectedItem instanceof Card&&self.selectedItem.drag(pointer,pointer.x,pointer.y+1.25*CARD_SMALL_HEIGHT),self.selectedItem instanceof Walker&&self.selectedItem.dragMe(pointer,pointer.x,pointer.y+1.25*CARD_SMALL_HEIGHT))})),this.phaser.input.on("pointerdown",(function(pointer,gameObject,event){var canvW=self.phaser.scale.canvasBounds.width;canvW<1&&(canvW=1),self.toolTip.x=pointer.x+1280/canvW*5,self.toolTip.y=pointer.y+1280/canvW*5;for(var i=0;i<self.town.blocks.length;i++)self.town.blocks[i].floatieTxt.visible=!1;if(1!=pointer.rightButtonDown()&&1!=pointer.middleButtonDown()&&1!=pointer.backButtonDown()&&1!=pointer.forwardButtonDown()||!self.isBulldozer){self.clickMode&&(0==pointer.rightButtonDown()||1==pointer.middleButtonDown()||1==pointer.backButtonDown()||1==pointer.forwardButtonDown()?null!=self.selectedItem&&(0==self.justSelected?self.justSelected=!0:(self.selectedItem instanceof Card&&self.selectedItem.endDrag(pointer),self.selectedItem instanceof Walker&&self.selectedItem.endDrag(pointer),self.justSelected=!1,self.drawer1.buttonOpen.button.setTexture("gui",self.drawer1.typeicon),self.drawer1.buttonOpen.hover.setTexture("gui",self.drawer1.typeicon+"_down"),self.drawer2.buttonOpen.button.setTexture("gui",self.drawer2.typeicon),self.drawer2.buttonOpen.hover.setTexture("gui",self.drawer2.typeicon+"_down"),self.drawer3.buttonOpen.button.setTexture("gui",self.drawer3.typeicon),self.drawer3.buttonOpen.hover.setTexture("gui",self.drawer3.typeicon+"_down"),self.drawer1.hideDeleteButton(),self.drawer2.hideDeleteButton(),self.drawer3.hideDeleteButton())):(self.justSelected=!1,null!=self.selectedItem&&self.selectedItem instanceof Walker&&(self.selectedSpot=null,self.selectedItem.endDrag(pointer)))),1!=pointer.rightButtonDown()&&1!=pointer.middleButtonDown()&&1!=pointer.backButtonDown()&&1!=pointer.forwardButtonDown()||self.selectedItem&&(self.selectedItem instanceof Card?(self.selectedItem.selected=!1,self.selectedItem.clicked=!1,self.selectedItem.collapseAndShrink()):(self.selectedItem,Worker),self.selectedSpot=null,self.selectedItem.endDrag(pointer)),self.pointerDownForDrawers(pointer,pointer.rightButtonDown()||pointer.middleButtonDown()||pointer.backButtonDown()||pointer.forwardButtonDown());for(var i=0;i<self.hand.cards.length;i++)1!=pointer.rightButtonDown()&&1!=pointer.middleButtonDown()&&1!=pointer.backButtonDown()&&1!=pointer.forwardButtonDown()||(self.selectedSpot=null,self.hand.cards[i].selected=!1,self.hand.cards[i].clicked=!1),0==self.hand.cards[i].clicked&&self.hand.cards[i].collapseAndShrink(),self.hand.cards[i].clicked=!1;self.hand.setSelectedCard(),self.hand.sortCards()}else self.switchSellMode(!1,pointer)}))}}