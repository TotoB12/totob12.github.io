class Town{constructor(game){this.game=game,this.phaser=game.phaser;var self=this;_defineProperty(this,"makeTown",()=>{this.pipes=[],this.blocks=[],this.nodes=[],this.walkers=[],this.population=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19],this.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19),this.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19),this.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19);for(var map_blocks=this.phaser.cache.xml.get("town_map").getElementsByTagName("block"),map_pipes=this.phaser.cache.xml.get("town_map").getElementsByTagName("pipe"),map_nodes=this.phaser.cache.xml.get("town_map").getElementsByTagName("node"),i=0;i<map_blocks.length;i++)this.blocks.push(new TownBlock(this.game,""+i));for(var i=0;i<map_pipes.length;i++)this.pipes.push(new TownPipe(this.game,""+i));for(var i=0;i<map_nodes.length;i++)this.nodes.push(new TownNode(this.game,""+i));this.nodes[WATER_SOURCE].hasPipeWater=!0;for(var i=0;i<map_blocks.length;++i){var item=map_blocks[i];this.blocks[i].blocks=item.getAttribute("blocks").split(","),this.blocks[i].pipes=item.getAttribute("pipes").split(","),this.blocks[i].nodes=item.getAttribute("nodes").split(",")}for(var i=0;i<map_pipes.length;++i){var item=map_pipes[i];this.pipes[i].blocks=item.getAttribute("blocks").split(","),this.pipes[i].pipes=item.getAttribute("pipes").split(","),this.pipes[i].nodes=item.getAttribute("nodes").split(",")}for(var i=0;i<map_nodes.length;++i){var item=map_nodes[i];this.nodes[i].blocks=item.getAttribute("blocks").split(","),this.nodes[i].pipes=item.getAttribute("pipes").split(","),this.nodes[i].nodes=item.getAttribute("nodes").split(","),this.nodes[i].column=item.getAttribute("column")}for(var i=0;i<this.blocks.length;++i){var item;(item=this.blocks[i]).init()}for(var i=0;i<map_pipes.length;++i)var item=map_pipes[i];for(var i=0;i<map_nodes.length;++i)var item=map_nodes[i];this.watersource.visible=!1,this.watersource2.visible=!1,this.updateSupply()}),_defineProperty(this,"showWellPower",()=>{var power=.5;this.game.selectedItem&&(power=.75);for(var i=0;i<this.columns.length;i++)this.phaser.tweens.add({targets:this.columns[i],alpha:power,ease:"Cubic.InOut",duration:250}),this.columns[i].visible=!0,this.columnWellPower[this.columns.length-1]-this.columnWellPower[i]>=3||0==this.columnWellPower[i]?this.columns[i].setTint("0x770000"):this.columnWellPower[this.columns.length-1]-this.columnWellPower[i]>=2?this.columns[i].setTint("0x552200"):this.columnWellPower[this.columns.length-1]-this.columnWellPower[i]>=1?this.columns[i].setTint("0x353500"):this.columnWellPower[this.columns.length-1]-this.columnWellPower[i]<=0&&this.columns[i].setTint("0x007700");for(var i=0;i<this.nodes.length;i++)this.nodes[i].showNodeWellPower();for(var i=0;i<this.columnsText.length;i++)this.columnsText[i].text="$"+this.columnWellPower[2*i]}),_defineProperty(this,"hideWellPower",good=>{var power=0;this.game.showPipes>=.5&&0==good&&(power=.5);for(var i=0;i<this.columns.length;i++)this.phaser.tweens.add({targets:this.columns[i],alpha:power,ease:"Cubic.InOut",duration:250});if(this.game.showPipes<.5||1==good)for(var i=0;i<this.columnsText.length;i++)this.columnsText[i].visible=!1,this.game.showWellPower&&(this.columnsText[i].visible=!0);if(this.game.showPipes<.5||1==good)for(var i=0;i<this.nodes.length;i++)this.nodes[i].hideNodeWellPower()}),_defineProperty(this,"resetSimulation",()=>{for(var i=0;i<this.blocks.length;i++)this.blocks[i].simulatedGain=0;if(null!=this.game.selectedItem&&null!=this.game.selectedItem.parentBlock&&null!=this.game.selectedItem.gainWater1&&(this.game.selectedItem.parentBlock.simulatedGain=-this.game.selectedItem.gainWater1,null!=this.game.selectedItem.gainWater2))for(var i=0;i<this.game.selectedItem.parentBlock.blocks.length;i++)this.blocks[this.game.selectedItem.parentBlock.blocks[i]].simulatedGain=-this.game.selectedItem.gainWater2;for(var i=0;i<this.blocks.length;i++)this.blocks[i].showUpdatedSupply(this.blocks[i].simulatedGain,0)}),_defineProperty(this,"showSupplyDemand",value=>{for(var i=0;i<this.blocks.length;i++)this.blocks[i].showSupplyDemand(0)}),_defineProperty(this,"hideSupplyDemandSoft",()=>{null==this.game.selectedItem&&0==this.game.isShowingGains&&this.hideSupplyDemand()}),_defineProperty(this,"hideSupplyDemand",value=>{if(1!=this.game.isShowingGains)for(var i=0;i<this.blocks.length;i++)this.blocks[i].simulatedGain=0,this.blocks[i].hideSupplyDemand()}),_defineProperty(this,"setGlobalEnabled",value=>{this.globalTargetBmp.input.enabled=value,this.globalTargetBmp.alpha=value?.5:0}),_defineProperty(this,"refreshPipesView",()=>{this.setStreetsEnabled(!1,!1),this.setBlocksEnabled(!1)}),_defineProperty(this,"setStreetsEnabled",(value,deleteOnly)=>{for(var i=0;i<this.pipes.length;i++)deleteOnly?this.pipes[i].setEnabled(value*(""!=this.pipes[i].builtId),!0):this.pipes[i].setEnabled(value,!1)}),_defineProperty(this,"setNodesEnabled",(value,deleteOnly,highlightOnly)=>{for(var i=0;i<this.nodes.length;i++)deleteOnly?this.nodes[i].setEnabled(value*(""!=this.nodes[i].builtId),!0,!1):highlightOnly?this.nodes[i].setEnabled(!1,!1,!0):this.nodes[i].setEnabled(value,!1,!1)}),_defineProperty(this,"incPop",result=>{this.sound=this.phaser.sound.add("demand"),this.sound.play({volume:1.5,detune:100*Math.random()-50}),this.blocks[result].demand+=1,this.blocks[result].showSupplyDemand2(ZOOM_TWEEN_1),this.blocks[result].updateSkin(),this.game.updateMoneyInfl(this.game.money,this.game.infl)}),_defineProperty(this,"increasePopulation",(howmuch,endturn,previousResult)=>{this.population.length<howmuch&&this.population.push(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19),howmuch--;var result=-1;if((result=this.population.length>0?this.population.splice(Math.floor(Math.random()*this.population.length),1):-2)>=0&&(this.blocks[result].showSupplyDemand2(0),this.game.flyMoney("`",this.blocks[result].x,this.blocks[result].y),setTimeout(this.incPop,1e3,result)),howmuch>0)result>=0?setTimeout(this.increasePopulation,5,howmuch,endturn,result):setTimeout(this.increasePopulation,1,howmuch,endturn,result);else if(1==endturn){var timer=2e3;-2==previousResult&&(timer=5),setTimeout(this.game.town.hideSupplyDemandSoft,2e3),setTimeout(this.game.endTurn3,timer)}}),_defineProperty(this,"calculateInflGain",()=>{for(var value=0,i=0;i<this.blocks.length;i++)this.blocks[i].fire>0?value-=5:this.blocks[i].supply-this.blocks[i].demand>=0?value+=1:this.blocks[i].supply-this.blocks[i].demand<-1&&(value-=2);return value}),_defineProperty(this,"calculateInflGainSimulated",()=>{for(var value=0,i=0;i<this.blocks.length;i++)this.blocks[i].fire>0?this.game.selectedSpot==this.blocks[i]&&1==this.blocks[i].fire?this.blocks[i].simulatedSupply-this.blocks[i].demand>=0?value+=1:this.blocks[i].simulatedSupply-this.blocks[i].demand<-1&&(value-=2):value-=5:this.blocks[i].simulatedSupply-this.blocks[i].demand>=0?value+=1:this.blocks[i].simulatedSupply-this.blocks[i].demand<-1&&(value-=2);return value}),_defineProperty(this,"earnInfl",()=>{var n=1,speed=100;this.game.isShowingGains=!0;for(var allGood=!0,i=0;i<this.blocks.length;i++){var fakepointer=new Object;fakepointer.x=this.blocks[i].x,fakepointer.y=this.blocks[i].y+20,setTimeout(this.blocks[i].showSupplyDemand3,100*n-50),this.blocks[i].fire>0?(allGood=!1,setTimeout(this.game.pay,100*n,0,5,fakepointer,!0,!0)):this.blocks[i].supply-this.blocks[i].demand>=0?setTimeout(this.game.pay,100*n,0,-1,fakepointer,!0,!0):this.blocks[i].supply-this.blocks[i].demand<-1?(allGood=!1,setTimeout(this.game.pay,100*n,0,2,fakepointer,!0,!0)):(allGood=!1,setTimeout(this.game.pay,100*n,0,0,fakepointer,!0,!0)),n++}1==allGood?(1!=this.game.difficulty&&this.game.ach_fortune_count++,this.game.ach_fortune_count>=ACH_PERFECT_TURNS&&this.game.unlockAchievement("fortune")):this.game.ach_fortune_count=0,setTimeout(this.game.endTurn2,100*(n+5))}),_defineProperty(this,"setBlocksEnabled",value=>{for(var i=0;i<this.blocks.length;i++)this.blocks[i].setEnabled(value)}),_defineProperty(this,"setWalkersEnabled",value=>{for(var i=0;i<this.walkers.length;i++)this.walkers[i].setEnabled(value)}),_defineProperty(this,"addWorker",(id,block,jump)=>{this.walkers.push(new Walker(this.game,id,block,jump))}),_defineProperty(this,"updateSupply",()=>{for(var i=0;i<this.blocks.length;i++)this.blocks[i].supply=0;for(var i=0;i<this.nodes.length;++i)if(this.nodes[i].hasPipeWater||"well"==this.nodes[i].builtId)for(var j=0;j<this.nodes[i].blocks.length;j++)"well"==this.nodes[i].builtId?this.blocks[this.nodes[i].blocks[j]].supply+=this.nodes[i].gainWater1:""!=this.nodes[i].builtId&&(this.blocks[this.nodes[i].blocks[j]].supply+=this.columnWellPower[this.nodes[i].column]);for(var i=0;i<this.walkers.length;++i)if(this.walkers[i].parentBlock){this.walkers[i].parentBlock.supply+=this.walkers[i].gainWater1;for(var j=0;j<this.walkers[i].parentBlock.blocks.length;j++)this.blocks[this.walkers[i].parentBlock.blocks[j]].supply+=this.walkers[i].gainWater2}this.game.alwaysShowSupplyDemand&&this.showSupplyDemand()}),_defineProperty(this,"refreshPipes",()=>{for(var i=0;i<this.nodes.length;i++)this.nodes[i].nodeBmp.alpha=0;this.checkWaterPath()}),_defineProperty(this,"checkWaterPath",()=>{for(var i=0;i<this.nodes.length;i++)this.nodes[i].hadPipeWater=this.nodes[i].hasPipeWater,this.nodes[i].hasPipeWater=!1;this.waterProbe(WATER_SOURCE);for(var i=0;i<this.nodes.length;i++)1==this.nodes[i].hadPipeWater&&0==this.nodes[i].hasPipeWater&&"sump"==this.nodes[i].builtId&&(this.waterChangedUpdateSupplyView(this.nodes[i]),this.nodes[i].noWaterBmp.visible=!0)}),_defineProperty(this,"waterChangedUpdateSupplyView",node=>{this.game.town.updateSupply();for(var i=0;i<node.blocks.length;i++)this.game.town.blocks[node.blocks[i]].showSupplyDemand(ZOOM_TWEEN_1);setTimeout(this.game.town.hideSupplyDemandSoft,1e3)}),_defineProperty(this,"waterProbe",num=>{this.nodes[num].hasPipeWater=!0,0==this.nodes[num].hadPipeWater&&"sump"==this.nodes[num].builtId&&this.waterChangedUpdateSupplyView(this.nodes[num]);for(var i=0;i<this.nodes[num].pipes.length;i++){var pipe=this.pipes[this.nodes[num].pipes[i]];if("pipe"==pipe.builtId)for(var j=0;j<pipe.nodes.length;j++)0==this.nodes[pipe.nodes[j]].hasPipeWater&&this.waterProbe(pipe.nodes[j])}}),_defineProperty(this,"spreadFire",()=>{for(var fire=0,i=0;i<this.blocks.length;i++)this.blocks[i].fireStarted=!1;for(var i=0;i<this.blocks.length;i++)this.blocks[i].fire>0&&0==this.blocks[i].fireStarted&&(this.blocks[i].spreadFire(),fire++);return fire}),this.layers=new Object,this.pipes=[],this.blocks=[],this.nodes=[],this.walkers=[],this.columnWellPower=[0,0,0,0,0,0,0,0],this.columns=[],this.columnsText=[],this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps0")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps1")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps2")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps3")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps4")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps5")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps6")),this.columns.push(this.phaser.add.sprite(0,0,"well_power","sumps7"));for(var tex=this.phaser.textures.get("well_power"),i=0;i<this.columns.length;i++)this.columns[i].x=tex.frames["sumps"+i].customData.spriteSourceSize.x+i-5,this.columns[i].y=tex.frames["sumps"+i].customData.spriteSourceSize.y,this.columns[i].setOrigin(0),this.columns[i].setDepth(10),this.columns[i].alpha=.75,this.columns[i].blendMode="ADD",this.columns[i].visible=!1;this.columnsText.push(this.phaser.add.bitmapText(150,260,"numbers_font","1")),this.columnsText.push(this.phaser.add.bitmapText(280,260,"numbers_font","2")),this.columnsText.push(this.phaser.add.bitmapText(400,260,"numbers_font","3")),this.columnsText.push(this.phaser.add.bitmapText(520,260,"numbers_font","4"));for(var i=0;i<this.columnsText.length;i++)this.columnsText[i].setDepth(LAYER_SUPPLY_DEMAND),this.columnsText[i].visible=!1;this.population=[],this.constructions=[""],this.river1=this.phaser.add.sprite(0,0,"river1_atlas"),this.river1.originX=0,this.river1.originY=0,this.river1.y=GAME_HEIGHT-this.river1.height,this.river2=this.phaser.add.sprite(0,0,"river2_atlas"),this.river2.originX=0,this.river2.originY=0,this.river2.x=GAME_WIDTH-this.river2.width,this.castle=this.phaser.add.sprite(0,0,"castle"),this.castle.setOrigin(0),this.castle.setDepth(900),this.bottom=this.phaser.add.sprite(0,0,"bottom"),this.bottom.setOrigin(0),this.bottom.setDepth(915),this.walls=[],this.wallsShadows=[],this.bridge1=this.phaser.add.sprite(0,0,"town_walls","bridge_A"),this.bridge2=this.phaser.add.sprite(0,0,"town_walls","bridge_B"),this.waterunderthebridge=this.phaser.add.sprite(0,0,"waterunderthebridge"),this.waterunderthebridge.setOrigin(0),this.waterunderthebridge.x=0,this.waterunderthebridge.y=0,this.waterunderthebridge.setDepth(399),this.waterunderthebridge.play("waterunderthebridge2");var tex=this.phaser.textures.get("town_walls");this.bridge1.x=tex.frames.bridge_A.customData.spriteSourceSize.x,this.bridge1.y=tex.frames.bridge_A.customData.spriteSourceSize.y,this.bridge1.setOrigin(0),this.bridge1.setDepth(400),this.bridge2.x=tex.frames.bridge_B.customData.spriteSourceSize.x,this.bridge2.y=tex.frames.bridge_B.customData.spriteSourceSize.y,this.bridge2.setOrigin(0),this.bridge2.setDepth(400);for(var i=1;i<=9;i++)this.walls.push(this.phaser.add.sprite(0,0,"town_walls","wall_A_"+i)),this.walls.push(this.phaser.add.sprite(0,0,"town_walls","wall_B_"+i)),this.wallsShadows.push(this.phaser.add.sprite(0,0,"town_walls","shadow_A_"+i)),this.wallsShadows.push(this.phaser.add.sprite(0,0,"town_walls","shadow_B_"+i)),this.walls[this.walls.length-2].x=tex.frames["wall_A_"+i].customData.spriteSourceSize.x,this.walls[this.walls.length-1].x=tex.frames["wall_B_"+i].customData.spriteSourceSize.x,this.walls[this.walls.length-2].y=tex.frames["wall_A_"+i].customData.spriteSourceSize.y,this.walls[this.walls.length-1].y=tex.frames["wall_B_"+i].customData.spriteSourceSize.y,this.wallsShadows[this.wallsShadows.length-2].x=tex.frames["shadow_A_"+i].customData.spriteSourceSize.x,this.wallsShadows[this.wallsShadows.length-1].x=tex.frames["shadow_B_"+i].customData.spriteSourceSize.x,this.wallsShadows[this.wallsShadows.length-2].y=tex.frames["shadow_A_"+i].customData.spriteSourceSize.y,this.wallsShadows[this.wallsShadows.length-1].y=tex.frames["shadow_B_"+i].customData.spriteSourceSize.y,this.walls[this.walls.length-2].setOrigin(0),this.walls[this.walls.length-1].setOrigin(0),this.wallsShadows[this.wallsShadows.length-2].setOrigin(0),this.wallsShadows[this.wallsShadows.length-1].setOrigin(0),i>=6?this.walls[this.walls.length-2].setDepth(10+i):this.walls[this.walls.length-2].setDepth(800+i),i>=6?this.walls[this.walls.length-1].setDepth(10+i):this.walls[this.walls.length-1].setDepth(800+i),this.wallsShadows[this.wallsShadows.length-2].setDepth(2),this.wallsShadows[this.wallsShadows.length-1].setDepth(2);this.river1.play("flow1"),this.river2.play("flow2"),this.river1.blendMode="ADD",this.river2.blendMode="ADD",this.river1.alpha=.5,this.river2.alpha=.5,this.waterCheck=[],this.mill=this.phaser.add.sprite(0,0,"mill_atlas"),this.mill.play("mill1"),this.mill.visible=!1,this.waterworks=this.phaser.add.sprite(0,0,"waterworks"),this.waterworks.play("waterworks1"),this.waterworks.setDepth(1e3),this.waterworks.setOrigin(0),this.waterworks.x=545,this.waterworks.y=0,this.waterworks.visible=!1,this.boat=this.phaser.add.sprite(-150,320,"boats"),this.boat.play("boat2"),this.boat.setDepth(909),this.boatSpeed=2,this.previousBoat="",this.boat.setOrigin(.5,1),this.watersource=this.phaser.add.sprite(0,0,"water_source"),this.watersource.play("water_source"),this.watersource.setDepth(1e3),this.watersource.displayOriginX=0,this.watersource.displayOriginY=0,this.watersource2=this.phaser.add.sprite(0,0,"water_source2"),this.watersource2.play("water_source2"),this.watersource2.setDepth(1e3),this.watersource2.displayOriginX=0,this.watersource2.displayOriginY=0,this.mill.displayOriginX=0,this.mill.displayOriginY=0,this.mill.x=-1,this.stable=this.phaser.add.sprite(0,0,"stable","stable1");var tex=this.phaser.textures.get("stable");this.stable.displayOriginX=0,this.stable.displayOriginY=0,this.stable.setDepth(850),this.stable.visible=!1,this.water_road=this.phaser.add.sprite(0,0,"water_road","water_road_a"),tex=this.phaser.textures.get("water_road"),this.water_road.displayOriginX=0,this.water_road.displayOriginY=0,this.water_road.x=tex.frames.water_road_a.customData.spriteSourceSize.x,this.water_road.y=tex.frames.water_road_a.customData.spriteSourceSize.y,this.water_road.setDepth(10),this.water_road.visible=!1,this.horse=this.phaser.add.sprite(0,0,"horse_atlas"),this.horse.play("horse_stand"),this.horse.visible=!1,this.horse.displayOriginX=0,this.horse.displayOriginY=0,this.horse.x=500,this.horse.y=276,this.horse.setDepth(900),this.globalTargetBmp=this.phaser.add.sprite(GAME_WIDTH/2,GAME_HEIGHT/2,"global_target"),this.globalTargetBmp.setDepth(LAYER_CURTAIN),this.globalTargetBmp.setOrigin(0),this.globalTargetBmp.x=GAME_WIDTH/2-this.globalTargetBmp.width/2,this.globalTargetBmp.y=10,this.globalTargetBmp.setInteractive({cursor:"pointer"}),this.globalTargetBmp.on("pointerover",(function(){self.game.selectedSpot=self,self.globalTargetBmp.alpha=1})),this.globalTargetBmp.on("pointerout",(function(){self.game.selectedSpot=null,self.globalTargetBmp.alpha=.5}))}}